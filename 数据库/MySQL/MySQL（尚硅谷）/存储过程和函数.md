# 存储过程

## 理解

- 含义：

  存储过程的英文是 Stored Procedure 。它的思想很简单，就是一组经过 <font color="red">预先编译</font> 的 SQL 语句

  的封装。

- 执行过程：

  存储过程预先存储在 MySQL 服务器上，需要执行的时候，客户端只需要向服务器端发出调用存储过程的命令，服务器端就可以把预先存储好的这一系列 SQL 语句全部执行。

- 好处：

  1. 简化操作，提高了sql语句的重用性，减少了开发程序员的压力
  2. 减少操作过程中的失误，提高效率

  1. 减少网络传输量（客户端不需要把所有的 SQL 语句通过网络发给服务器）
  2. 减少了 SQL 语句暴露在网上的风险，也提高了数据查询的安全性



## 创建存储过程

```mysql
CREATE PROCEDURE 存储过程名(IN|OUT|INOUT 参数名 参数类型,...)
[characteristics ...]
BEGIN
存储过程体
END
```





通常需要设置新的结束标记：

```mysql
DELIMITER $
CREATE PROCEDURE 存储过程名(IN|OUT|INOUT 参数名 参数类型,...)
[characteristics ...]
BEGIN
    sql语句1;
    sql语句2;
END $
```



- DECLARE：声明变量
- SET：赋值变量
- SELECT… INTO：把从数据表中查询的结果存放到变量中，也就是为变量赋值。





例如：
```mysql
DELIMITER //
CREATE PROCEDURE show_someone_salary2(IN empname VARCHAR(20),OUT empsalary DOUBLE)
BEGIN
	SELECT salary INTO empsalary FROM emps WHERE ename = empname;
END //
DELIMITER ;
```



## 调用存储过程

```mysql
CALL 存储过程名(实参列表)
```



- 调用in模式的参数：

  ```mysql
  CALL sp1('值');
  ```

- 调用out模式的参数：

  ```mysql
  SET @name;
  CALL sp1(@name);
  SELECT @name;
  ```

- 调用inout模式的参数：

  ```mysql
  SET @name=值;
  CALL sp1(@name);
  SELECT @name;
  ```





# 存储函数

## 定义

```mysql
CREATE FUNCTION 函数名(参数名 参数类型,...)
RETURNS 返回值类型
[characteristics ...]
BEGIN
	函数体 #函数体中肯定有 RETURN 语句
END
```

- FUNCTION中总是默认为IN参数



## 调用

用户自己定义的存储函数与MySQL内部函数是一个性质的。  

```mysql
SELECT 函数名(实参列表)
```





```mysql
DELIMITER //
CREATE FUNCTION email_by_name()
RETURNS VARCHAR(25)
DETERMINISTIC
CONTAINS SQL
BEGIN
	RETURN (SELECT email FROM employees WHERE last_name = 'Abel');
END //
DELIMITER ;
```

```mysql
SELECT email_by_name();
```



# 对比

|           | 关键字    | 调用语法        | 返回值             | 应用场景                          |
| --------- | --------- | --------------- | ------------------ | --------------------------------- |
| 存储过 程 | PROCEDURE | CALL 存储过程() | 理解为有0个或 多个 | 一般用于更新                      |
| 存储函 数 | FUNCTION  | SELECT 函数 ()  | 只能是一个         | 一般用于查询结果为一个值并 返回时 |



- 此外，存储函数可以放在查询语句中使用，存储过程不行。

- 反之，存储过程的功能更加强大，包括能够执行对表的操作（比如创建表，删除表等）和事务操作，这些功能是存储函数不具备的。  



