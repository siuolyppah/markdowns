# Basic

使用委托时，通常可以定义两个角色：

- 广播者：

  包含一个委托字段。

- 订阅者：

  在委托对象上调用`+=`和`-=`。





- 事件，是将上述订阅模式正式化的语言特性。

- 事件是一种结构，用于实现 广播/订阅 模式。

  <font color="red">它只暴露了委托特性的部分子集</font>（即类的外部，仅可对事件进行`+=`和`-=`）。

- 事件的主要目的，是防止订阅者之间相互干扰。



# 事件的访问器

事件访问器，是对`+=`和`-=`的实现。

```cs
public event EventHandler PriceChanged;
```

编译器会将其转换为：

- 一个私有的委托字段

- 一对公共的事件访问器函数：

  - add_PriceChanged();
  - remove_PriceChanged();

  使用`+=`和`-=`，就是调用这两个函数。



也可以显式定义：
```cs
private EventHandler priceChanged;
public event EventHandler PriceChanged{
    add 	{ priceChanged += value};
    remove  { priceChanged -= value};
}
```







# 标准的事件模式

- .Net定义了一个标准的事件模式：

  `System.EventArgs`，它是一个预定义的框架类。

  其成员仅有一个静态的Empty属性。

- `EventArgs`是为事件传递信息的类的基类。



模式如下：

- 发布者

- 传递信息类：

  - 通常继承自`System.EventArgs`
  - 通常用所含有信息的含义来命名。而非所使用事件名。

- 订阅者，为事件选择或定义委托：

  - 返回类型为void
  - 接收两个参数：
    - 第一个参数为object，表示事件的广播者；
    - 第二个参数为EventArgs的子类，用于包含传递的信息。
  - 名称以EventHandler结尾。

  > .Net Framework定义了一个泛型委托`System.EventHandler<T>`:
  >
  > ```cs
  > public delegate void EventHandler<TEventArgs>
  >     (object source, TEventArgs e) where TEventArgs:EventArgs;
  > ```

- 针对选择的委托，定义事件。

- 可触发事件的protected virtual方法。

  > - 方法名："On" + 事件名；
  > - 接收一个EventArgs参数。





```cs
public class PriceChangedEventArgs : System.EventArgs
{
    public readonly decimal OldPrice;
    public readonly decimal NewPrice;

    public PriceChangedEventArgs(decimal oldPrice, decimal newPrice)
    {
        OldPrice = oldPrice;
        NewPrice = newPrice;
    }
}

class Publisher
{
    public event EventHandler<PriceChangedEventArgs> PriceChanged;
    
    protected virtual void OnPriceChanged(PriceChangedEventArgs e)
    {
        PriceChanged?.Invoke(this, e);
    }
    
    private decimal _price;
    public decimal Price
    {
        get { return _price; }
        set
        {
            if (_price == value) return;
            
            decimal oldPrice = _price;
            _price = value;
            OnPriceChanged(new PriceChangedEventArgs(oldPrice, _price));
        }
    }
}

class Program
{
    static void MyHandler(object sender, PriceChangedEventArgs e)
    {
        Console.WriteLine($"Old:{e.OldPrice},New:{e.NewPrice}");
    }

    static void Main(string[] args)
    {
        Publisher publisher = new Publisher();

        publisher.Price = 120;
        publisher.PriceChanged += MyHandler;
        publisher.Price = 130;

    }
}
```









