# å¯åŠ¨çº¿ç¨‹

ç®€å•çš„è¯´ï¼Œä½¿ç”¨C++çº¿ç¨‹åº“å¯åŠ¨çº¿ç¨‹ï¼Œå°±æ˜¯æ„é€ `std::thread`å¯¹è±¡ã€‚



- ä¼ é€’å‡½æ•°ï¼š

  ```C++
  #include <iostream>
  #include <thread>
  
  void do_some_work(){
      std::cout << "hello" << std::endl;
  }
  
  int main(){
  	std::thread my_thread(do_some_work);
      my_thread.join();
  }
  ```

- ä¼ é€’å‡½æ•°å¯¹è±¡ï¼š

  ```C++
  #include <iostream>
  #include <thread>
  
  class background_task {
  public:
  	void operator()() const {
  		std::cout << "hello" << std::endl;
  	}
  };
  
  int main() {
  	background_task f;
  
  	std::thread t(f);
  	t.join();
  }
  ```

  >æä¾›çš„å‡½æ•°å¯¹è±¡ï¼Œå°†è¢«å¤åˆ¶åˆ°æ–°çº¿ç¨‹çš„å­˜å‚¨ç©ºé—´ã€‚

  > éœ€è¦æ³¨æ„ï¼šå½“ä¼ é€’ä¸´æ—¶å¯¹è±¡æ—¶ï¼ŒC++ç¼–è¯‘å™¨ä¼šå°†å…¶è§£æä¸ºå‡½æ•°å£°æ˜ï¼Œè€Œéå¯¹è±¡çš„å®šä¹‰ã€‚
  >
  > ```C++
  > std::thread my_thread(background_task());
  > ```
  >
  > ç›¸å½“äºå£°æ˜äº†ä¸€ä¸ªå‡½æ•°ï¼š
  >
  > - å‡½æ•°åä¸ºï¼šmy_thread
  > - è¿”å›ç±»å‹ä¸ºï¼šstd::thread
  > - å½¢å‚ä¸ºï¼šä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆæŒ‡å‘æ²¡æœ‰å‚æ•°ï¼Œè¿”å›ç±»å‹ä¸ºbackground_taskå¯¹è±¡çš„å‡½æ•°ï¼‰
  >
  > è§£å†³æ–¹æ¡ˆï¼š
  >
  > - å¤šæ·»åŠ ä¸€ä¸ªæ‹¬å·ï¼š
  >
  >   ```C++
  >   std::thread my_thread((background_task()));
  >   ```
  >
  > - ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼š
  >
  >   ```C++
  >   std::thread my_thread{background_task()};
  >   ```

- ä¼ é€’Lambdaè¡¨è¾¾å¼ï¼š

  ```C++
  int main() {
  	std::thread t([]{
  		std::cout << "hello" << std::endl;
  	});
  
  	t.join();
  }
  ```

  



# ç¡®ä¿çº¿ç¨‹æ‰€è®¿é—®æ•°æ®çš„æœ‰æ•ˆæ€§

å‡½æ•°å·²ç»è¿”å›ï¼Œçº¿ç¨‹ä¾æ—§è®¿é—®å±€éƒ¨å˜é‡ï¼š

```C++
struct func
{
	int& i;
	func(int& i_) : i(i_) {}
	void operator() ()
	{
		for (unsigned j = 0; j < 1000000; ++j)
		{
			do_something(i);	// 1 æ½œåœ¨è®¿é—®éšæ‚£ï¼šç©ºå¼•ç”¨
		}
	}
};
void oops()
{
	int some_local_state = 0;
	func my_func(some_local_state);
	std::thread my_thread(my_func);
	my_thread.detach();			// 2 ä¸ç­‰å¾…çº¿ç¨‹ç»“æŸ
}								// 3 æ–°çº¿ç¨‹å¯èƒ½è¿˜åœ¨è¿è¡Œ
```

åœ¨è¯¥ä»£ç ä¸­ï¼Œå·²ç»å†³å®šä¸ç­‰å¾…çº¿ç¨‹(ä½¿ç”¨äº†detach()â‘¡)ï¼Œæ‰€ä»¥å½“oops()å‡½æ•°æ‰§è¡Œå®Œæˆæ—¶â‘¢ï¼Œçº¿ç¨‹ä¸­çš„å‡½æ•°å¯èƒ½è¿˜åœ¨è¿è¡Œã€‚

å¦‚æœçº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œå°±ä¼šå»è°ƒç”¨do_something(i)â‘ ï¼Œè¿™æ—¶å°±ä¼šè®¿é—®å·²ç»é”€æ¯çš„å˜é‡ã€‚  è¿™å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚

|             ä¸»çº¿ç¨‹              |                            æ–°çº¿ç¨‹                            |
| :-----------------------------: | :----------------------------------------------------------: |
| ä½¿ç”¨some_local_stateæ„é€ my_func |                                                              |
|       å¼€å¯æ–°çº¿ç¨‹my_thread       |                                                              |
|              å¯åŠ¨               |                                                              |
|      è°ƒç”¨func::operator()       |                                                              |
|         å°†my_threadåˆ†ç¦»         | æ‰§è¡Œfunc::operator();å¯èƒ½ä¼šåœ¨do_somethingä¸­è°ƒç”¨some_local_stateçš„å¼•ç”¨ |
|      é”€æ¯some_local_state       |                           æŒç»­è¿è¡Œ                           |
|          é€€å‡ºoopså‡½æ•°           | æŒç»­æ‰§è¡Œfunc::operator()ï¼›å¯èƒ½ä¼šåœ¨do_somethingä¸­è°ƒç”¨ some_local_stateçš„å¼•ç”¨ --> å¯¼è‡´æœªå®šä¹‰è¡Œä¸º |



<font color="red">å¤„ç†æ–¹æ¡ˆï¼šå°†æ•°æ®ï¼Œå¤åˆ¶åˆ°çº¿ç¨‹ä¸­</font>ã€‚

> ### ğŸ’¡
>
> ä¸è¦ä½¿ç”¨ï¼Œè®¿é—®å±€éƒ¨å˜é‡çš„å‡½æ•°ï¼Œåˆ›å»ºçº¿ç¨‹å¯¹è±¡ã€‚



# ç­‰å¾…çº¿ç¨‹ç»“æŸ

```C++
thread t(func);
t.join();
```



æ³¨æ„ï¼š

- åªèƒ½å¯¹åŒä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œä½¿ç”¨ä¸€æ¬¡join()ã€‚

  > ä½¿ç”¨è¿‡ä¸€æ¬¡join()åï¼Œè°ƒç”¨joinable()å°†è¿”å›falseã€‚



## ä¿è¯join()ä¸ä¼šå› æŠ›å‡ºå¼‚å¸¸è€Œè·³è¿‡

```C++
void func();

void f(){
    std::thread t(func);
    try{
        do_something_in_current_thread();
    }
    catch(...){
        t.join();
        throw;
    }
    t.join();
}
```

ä¸è¦å› ä¸ºæŠ›å‡ºå¼‚å¸¸å¼•èµ·çš„æ‰§è¡Œæµå˜åŒ–ï¼Œè€Œè·³è¿‡join()ã€‚



## ä½¿ç”¨RAIIä¿è¯ç­‰å¾…çº¿ç¨‹

- RAIIï¼ˆResources Acquisition Is Initialization)ï¼š

  èµ„æºè·å–ï¼Œå³åˆå§‹åŒ–æ–¹å¼ã€‚



```C++
class thread_guard
{
private:
	std::thread& t;

public:
	explicit thread_guard(std::thread& _t)
		:t(_t)
	{}

	~thread_guard() {
		if (t.joinable()) {
			t.join();
		}
	}

	thread_guard(thread_guard const&) = delete;
	thread_guard& operator=(thread_guard const&) = delete;
};

void f() {
	int x = 100;
	std::thread t([&x]{
		for (int i = 0; i < x; i++) {
		std:; cout << "thread" << std::endl;
		}
	});

	thread_guard g(t);
	
	do_something_in_current_thread();
}
```

- å½“f()æ­£å¸¸æ‰§è¡Œç»“æŸæ—¶ï¼Œå±€éƒ¨å¯¹è±¡å°†é€†åºé”€æ¯ã€‚
- è‹¥do_something_in_current_thread()æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿä¼šè§¦å‘å±€éƒ¨å¯¹è±¡çš„é”€æ¯ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚



# åå°è¿è¡Œçº¿ç¨‹

```C++
thread t(func);
t.detach();
```

ä½¿ç”¨detach()ï¼Œå¯å°†çº¿ç¨‹åˆ†ç¦»ï¼Œä½¿å…¶åœ¨åå°è¿è¡Œã€‚ï¼ˆå³å®ˆæŠ¤çº¿ç¨‹ï¼‰ã€‚

>- C++æ ‡å‡†åº“ä¿è¯ï¼Œå½“å®ˆæŠ¤çº¿ç¨‹é€€å‡ºæ—¶ï¼Œèƒ½æ­£ç¡®å›æ”¶ç›¸å…³èµ„æºã€‚
>
>- è°ƒç”¨detach()åçš„threadå¯¹è±¡ï¼Œå°†ä¸å®é™…æ‰§è¡Œçš„çº¿ç¨‹æ— å…³ï¼Œä¹Ÿæ— æ³•å†join();
>
>  ```C++
>  int main()
>  {
>  	std::thread t([] {
>  		std::cout << "hello" << std::endl;
>  	});
>  	
>  	std::cout << "id:" << t.get_id() << std::endl;	// 15528
>  	t.detach();
>  	std::cout << "id:" << t.get_id() << std::endl;	// 0
>  	std::cout << "joinable?" << t.joinable() << std::endl;	//false
>  
>  
>  	return 0;
>  }
>  ```



# ä¼ é€’å‚æ•°

åœ¨æ„é€ threadå¯¹è±¡æ—¶ï¼Œå¯ä»¥åŒæ—¶ä¼ é€’å‚æ•°ï¼ˆç”¨äºè°ƒç”¨å¯è°ƒç”¨å¯¹è±¡æˆ–å‡½æ•°ï¼‰ã€‚

```C++
void print(int x) {
	std::cout << x << std::endl;
}

int main()
{
	std::thread t(print, 10);	// å‚æ•°10ï¼Œç”¨äºè°ƒç”¨print()
	t.join();

	return 0;
}
```



- æ„é€ threadå¯¹è±¡æ—¶ï¼Œä¼ é€’çš„å‚æ•°ï¼Œå°†è¢«æ‹·è´è‡³æ–°çº¿ç¨‹çš„å†…å­˜ç©ºé—´ã€‚

  > å³ä¾¿å‡½æ•°å½¢å‚å£°æ˜ä¸ºå¼•ç”¨ç±»å‹ï¼Œå®å‚ä¹Ÿå°†è¢«æ‹·è´ã€‚
  >
  > ```C++
  > class MyObj {
  > public:
  > 	MyObj(){}
  > 	MyObj(const MyObj&) {
  > 		std::cout << "æ‹·è´æ„é€ " << std::endl;
  > 	}
  > 
  > 	~MyObj() {}
  > };
  > 
  > void doSomething(const MyObj& obj) {
  > }
  > 
  > int main()
  > {
  > 	MyObj obj;
  > 	thread t(doSomething,obj);	// æ‰“å°â€œæ‹·è´æ„é€ â€
  > 	t.detach();
  > 
  > 	this_thread::sleep_for(chrono::milliseconds(100));
  > 
  > 	return 0;
  > }
  > ```



- ä¼ é€’å‚æ•°æ—¶ï¼Œthreadå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œ**ä¼šå°†æ‹·è´çš„å‚æ•°ä»¥å³å€¼ä¼ é€’**ï¼š

  ```C++
  void update_data_for_widget(widget_id w,widget_data& data); // 1
  void oops_again(widget_id w)
  {
      widget_data data;
      std::thread t(update_data_for_widget,w,data); // 2
      display_status();
      t.join();
      process_widget_data(data);
  }
  ```

  threadç±»çš„å†…éƒ¨ä»£ç ï¼Œä¼šæ‹·è´dataå¯¹è±¡ï¼Œä¹‹åå°†å°è¯•ä»¥å³å€¼ä¸ºå®å‚ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œæœ€ç»ˆå¯¼è‡´**ç¼–è¯‘å‡ºé”™**ã€‚

  

  è§£å†³æ–¹æ¡ˆï¼š

  ä½¿ç”¨`std::ref`ï¼Œå°†å‚æ•°è½¬æ¢æˆå¼•ç”¨ç±»å‹ã€‚

  ```C++
  std::thread t(update_data_for_widget,w,std::ref(data));
  ```

  æ­¤æ—¶ï¼Œthreadç±»å°±ä¼šå—åˆ°dataçš„å¼•ç”¨ï¼Œè€Œédataçš„æ‹·è´å‰¯æœ¬ï¼Œä»è€Œé€šè¿‡ç¼–è¯‘ã€‚



# è½¬ç§»æ‰€æœ‰æƒ

2.3 è½¬ç§»æ‰€æœ‰æƒ
