# Linux的ext2文件系统（inode）

![image-20220914143042820](Linux%E7%A3%81%E7%9B%98%E4%B8%8E%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86.assets/image-20220914143042820.png)



ext2文件系统，在格式化时，区分为多个区块群组（block group）。

一个区块群组的组成：

- superblock：

  - 记录的信息：
    - 数据区块和inode的总量。
    - 未使用与已使用的数据区块和inode的数量。
    - 数据区块（1K、2K、4K）与inode大小（128B、256B）。
    - 记录文件系统的相关信息，例如文件系统的挂载时间、最后一次写入数据的时间、最近一次检验硬盘的时间（fsck）。
    - 一个有效位数值。若该文件系统已挂载，则有效位为0；否则为1。

- ==inode table==：

  - inode记录的信息：

    - 该文件的读写属性（rwx）

    - 该文件的拥有者（owner）、用户组（group）

    - 该文件的大小

    - 该文件建立或状态改变的时间（ctime）

    - 最近一次的读取时间（atime）

    - 最近修改的时间（mtime）

    - 定义文件特性的标识（flag），如SetUID

    - 该文件真正内容的指向（pointer）。

      > 关于pointer的直接记录、间接记录、双间接记录、三间接记录见P214。

  - 每个inode大小固定为128B（ext4和xfs可设置到256B）。

  - 一个文件，对应一个inode。

  - 系统读取文件时，先找到inode。在分析inode所记录的权限与用户符号后，再读取区块内容。

- ==data block==：

  - ext2文件系统，所支持的区块大小有1K、2K、4K。
  - 每个区块在格式化时确定大小，且每个区块都有编号。
  - 每个区块内，只能放置一个文件的数据。
    - 多的空间会被浪费。

  ![image-20220914144548138](Linux%E7%A3%81%E7%9B%98%E4%B8%8E%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86.assets/image-20220914144548138.png)

  > 上图为ext2文件系统。

- 文件系统描述：

  用于描述每个区块群组的开始与结束区块。

- 区块对应表：

  记录使用与未使用的区块号码。

- inode对应表：

  记录使用与未使用的inode号码。



# 与目录树的关系

在Linux系统下，每个文件（不管是一般文件或目录文件），都会占用一个inode。



- 目录：当在文件系统下建立一个目录时，系统会分配一个indoe与至少一个区块。

  - inode：

    记录该目录的相关权限、属性、datablock的区块号码。

  - 区块：

    ==记录在这个文件下的文件名==、该文件名占用的inode号码数据。

  ```sh
  [gxy@arch test]$ ls -li
  总计 68
  1969992 -rwxr-xr-x 1 gxy gxy 21848  9月13日 13:22 a.out
  1970001 -rwxrwxrwx 1 gxy gxy     8  9月11日 09:13 bak.txt
  1969991 drwxr-xr-x 2 gxy gxy  4096  9月11日 11:09 f
  1969994 -rw-r--r-- 1 gxy gxy  8688  9月11日 12:10 ls.txt
  1969993 -rw-r--r-- 1 gxy gxy  1292  9月13日 13:32 main.cpp
  1970002 -rw-r--r-- 1 gxy gxy  4316  9月11日 19:08 od.help
  1970003 -rw-r--r-- 1 gxy gxy    56  9月11日 19:17 od.test
  1969990 -rw-r--r-- 1 gxy gxy    99  9月11日 11:19 path.txt
  1969989 -rwxrwxrwx 1 gxy gxy    65  9月11日 14:15 test.txt
  1970004 -rw-r--r-- 1 gxy gxy     0  9月11日 19:34 t.txt
  ```

- 文件：

  当在Linux下的ext2建立一个一般文件时，会分配一个inode与相对与该文件大小的区块数量。

  例如，若一个区块为4KB，当建立一个100KB的文件时，将分配一个inode、25个区块，又因为一个inode只能由12个直接指向，又会分配一个区块用于记录区块号码。





## 目录树的读取

1. ==系统通过挂载的信息，可找到挂载点的inode号码==，从而得到根目录的inode内容。
2. 在该inode对应的数据区块中，记录了这个文件夹下的各个文件或目录的inode号码。
3. 根据此inode号码，即可找到对应的inode节点，从而读取文件或目录。



例如，读取/etc/passwd这个文件的过程：

```sh
[gxy@arch test]$ ls -ldi / /etc /etc/passwd
      2 drwxr-xr-x 17 root root 4096  9月 9日 12:26 /
2359297 drwxr-xr-x 89 root root 4096  9月14日 14:57 /etc
2360808 -rw-r--r--  1 root root 1394  9月 9日 12:43 /etc/passwd
```

1. /的inode：

   通过挂载点的信息，找到inode号码为2的根目录的inode，且用户具有rx权限，能够读取数据区块。

2. /的区块：

   经过上一个步骤得到区块的号码（利用inode的pointer），找到该内容有/etc目录的inode号码（2359297）。

3. etc/的inode：

   读取2359297号inode，得到用户具有rx权限，因此可以读etc/的区块内容。

4. etc/的区块：

   经过上一个步骤得到区块的号码，并找到该内容有passwd文件的inode号码（2360808）。

5. passwd的inode：

   读取2360808号inode，得知用户具有r的权限，因此可以读取区块内容。

6. passwd的区块：

   读取文件。

> 总结：
>
> - 目录项，存储了文件名和inode编号。
> - inode节点，存储了权限信息和数据区块的编号。



## 新增文件

新增文件的流程：

1. 先确定用户对于欲新增文件的目录，是否具有wx权限；
2. 根据inode对照表，找到一个没有使用的inode号码，将新文件的权限/属性写入；
3. 根据区块对照表，找到没有使用的区块号码，将实际的数据写入其中，并更新inode的pointer。
4. 将刚才写入的inode与区块数据，同步更新inode对照表与区块对照表。并更新超级块。



## 日志文件系统

- 数据存放区域：inode table，data block。
- metadata（中介数据）：superblock、block bitmap、inode bitmap。



在新增文件的过程中，如果已经文件已经写入，但还来得及更新metadata，因某些原因造成系统中断，将导致metadata与实际数据存放区不一致的情况。



- 在ext2中，如果发生这个问题，需要在系统重新启动时，借用超级块中记录的有效位（是否有挂载）与文件系统状态（正确卸载与否）等状态，来进行数据一致性的检查。这种检查需要对整个文件系统进行查找。

- 在ext3和ext4中，引入了日志文件系统：

  在文件系统中，划分出一个区块，用于记录写入或修改文件时的步骤。即：

  1. 预备：当系统要写入一个文件时，会先在日志记录区块中记录某个文件准备要写入的信息。
  2. 实际写入：开始写入文件的权限与数据；开始更新metadata的数据。
  3. 结束：完成数据与metadata的更新后，在日志记录区块中完成该文件的记录。





# Linux支持的其他文件系统

- 传统文件系统：

  ext2、minix、FAT（用vfat模块）、iso9660（光盘）等。

- 日志式文件系统：

  ext3、ext4、ReiserFs、Windows'NTFS、IBM's JFS、SGI's XFS、ZFS

- 网络文件系统：

  NFS、SMBFS



# XFS文件系统

> XFS可以具备几乎所有ext4文件系统的功能。



XFS文件系统的数据分布，主要划分为：

- 数据区（data section）：

  类似于ext的区块群组，划分为了多个存储区群组（allocation groups）。

  每个存储区群组，都包含了：

  1. 整个文件系统的超级区块
  2. 剩余空间的管理机制
  3. inode的分配与追踪。

  > inode与区块都是系统用到时才动态配置产生，因此格式化速度快。

  >- XFS的区块容量：512B~64KB间调整。
  >- inode容量：256B~2MB。

- 文件系统活动登陆区（log section）：

  类似于日志区。

- 实时运行区（realtime section）：

  当有文件文件被建立时，先在这个区段中找到一个或数个的extent区块，将文件放置在这个区块内，等到分配完毕后，再写入data section的inode与区块中。





# 文件系统的简单操作

## 磁盘与目录的容量

>- 磁盘的整体数据，放在超级区块中。
>- 每个文件的容量，在对应的inode节点中记录。



- `df`：

  列出文件系统的整体磁盘使用量。

  ```sh
  [gxy@arch test]$ df
  文件系统         1K的块     已用     可用 已用% 挂载点
  dev             4044180        0  4044180    0% /dev
  run             4052256     1536  4050720    1% /run
  /dev/sda2      46646068 12457860 31786316   29% /
  tmpfs           4052256        0  4052256    0% /dev/shm
  tmpfs           4052260    27480  4024780    1% /tmp
  /dev/sda1        523244      160   523084    1% /boot/EFI
  tmpfs            810448       64   810384    1% /run/user/1000
  ```

  选项与参数：P225

  - -a：列出所有的文件系统，包含系统特有的/proc等文件系统。
  - -T：额外显示文件系统名称
  - -i：不使用磁盘容量，而以inode的数量显示

- `du`：

  查看文件系统的磁盘使用量（常用在查看目录所占磁盘空间）。

  > 到文件系统中查找，而非查找超级块。

  

# 硬链接与符号链接：ln

## 硬链接

> review：
>
> - 每个文件占用一个inode，文件内容由inode的pointer来指向。
> - 想要读取该文件，必须经过目录记录的文件名，来指向正确的inode号码。
>
> 也就是说，文件名只与目录有关；文件内容则与inode有关。



硬链接，即在某个目录下，新增一条文件名，链接到某个inode号码的关联记录。

> 也就是说，这两个文件，就文件名不同。



硬链接的效果：

- 因为只存在一份文件，因此修改是同步的。
- 将任何一个文件名删除，其inode和区块还是存在的。



硬链接的限制：

- 不能跨文件系统
- 不能链接目录



## 符号链接（亦即快捷方式）

符号链接是**建立一个独立的文件**，而这个文件会让数据的读取指向它链接的那个文件的文件名。



符号链接的效果：

- 存在两个文件，其中符号链接文件指向源文件。
- 对任意一个文件的修改，是同步的。



符号链接的限制：

- 当源文件被删除后，符号链接的文件将打不开。





# 磁盘的分区、格式化、校验与挂载

7.3节