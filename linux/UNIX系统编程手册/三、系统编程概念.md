# 系统调用

在深入系统调用的运作方式之前，务必关注以下几点。

- 系统调用将处理器从用户态切换到核心态，以便 CPU 访问受到保护的内核内存。

- 系统调用的组成是固定的，每个系统调用都由一个唯一的数字来标识。（程序通过名称来标识系统调用，对这一编号方案往往一无所知。）

- 每个系统调用可辅之以一套参数，对用户空间（亦即进程的虚拟地址空间）与内核空间之间（相互）传递的信息加以规范。





==执行系统调用的步骤==：

1. 应用程序通过调用 C 语言函数库中的外壳（wrapper）函数，来发起系统调用。

2. 对系统调用中断处理例程（稍后介绍）来说，外壳函数必须保证所有的系统调用参数可用。通过堆栈，这些参数传入外壳函数，但内核却希望将这些参数置入特定寄存器。因此，外壳函数会将上述参数复制到寄存器。

3. 由于所有系统调用进入内核的方式相同，内核需要设法区分每个系统调用。为此，外壳函数会将系统调用编号复制到一个特殊的 CPU 寄存器（%eax）中。

4. 外壳函数执行一条中断机器指令（int 0x80），引发处理器从用户态切换到核心态，并执行系统中断 0x80 (十进制数 128)的中断矢量所指向的代码。

5. 为响应中断 0x80，内核会调用 system_call()例程（位于汇编文件 arch/i386/entry.S 中）来处理这次中断，具体如下。

   1. 在内核栈中保存寄存器值
   2. 审核系统调用编号的有效性
   3. 以系统调用编号对存放所有调用服务例程的列表（内核变量 sys_call_table）进行索引，发现并调用相应的系统调用服务例程。若系统调用服务例程带有参数，那么将首先检查参数的有效性。例如，会检查地址指向用户空间的内存位置是否有效。随后，该服务例程会执行必要的任务，这可能涉及对特定参数中指定地址处的值进行修改，以及在用户内存和内核内存间传递数据（比如，在 I/O 操作中）。最后，该服务例程会将结果状态返回给 system_call()例程。
   4. 从内核栈中恢复各寄存器值，并将系统调用返回值置于栈中。
   5. 返回至外壳函数，同时将处理器切换回用户态。

6. 若系统调用服务例程的返回值表明调用有误，外壳函数会使用该值来设置全局变量 errno。然后，外壳函数会返回到调用程序，并同时返回一个整型值，以表明系统调用是否成功。

   >在 Linux 上，系统调用服务例程遵循的惯例是调用成功则返回非负值。发生错误时，例程会对相应 errno 常量取反，返回一负值。C 语言函数库的外壳函数随即对其再次取反（负负得正），将结果拷贝至 errno，同时以-1 作为外壳函数的返回值返回，向调用程序表明有错误发生。
   >
   >>一般情况下，这也不会有问题，因为取反的 errno值范围不会与调用成功返回负值的范围有交集。不过，有一种情况，沿用这个惯例确实会出问题：系统调用 fcntl()的 F_GETOWN 操作



![image-20221023140147054](%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%A6%82%E5%BF%B5.assets/image-20221023140147054.png)



# 库函数

库函数 perror()和strerror()，根据 errno 值打印错误消息。

- 函数 perror()会打印出其 msg 参数所指向的字符串，紧跟一条与当前 errno 值相对应的消息。

  ```C
  fd = open(pathname, flags, mode);
  if(fd == -1){
      perror("open");
      exit(EXIT_FAILURE);
  }
  ```

- 函数 strerror()会针对其 errnum 参数中所给定的错误号，返回相应的错误字符串。





# 系统数据类型`<sys/types.h>`

- 大多数类型，均以`_t`结尾。

- 多数声明于头文件`<sys/types.h>`中。

  > 目录`/usr/include`下查找。

![image-20221023144937123](%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%A6%82%E5%BF%B5.assets/image-20221023144937123.png)![image-20221023144953693](%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%A6%82%E5%BF%B5.assets/image-20221023144953693.png)





