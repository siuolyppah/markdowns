# 程序组成

![image-20221025183142017](%E5%85%AD%E3%80%81%E8%BF%9B%E7%A8%8B.assets/image-20221025183142017.png)



从内核角度看，进程由以下两部分组成：

- 用户内存空间（user-space memory）：包含了程序代码及代码所使用的变量
- 一系列内核数据结构：用于维护进程状态信息



# 进程号与父进程号

- `pid_t getpid();`
- `pid_t getppid();`



# 进程的内存布局

每个进程所分配的内存由很多部分组成，==通常称之为“段（segment）”==。

- 文本段包含了进程运行的程序机器语言指令。文本段具有只读属性，以防止进程通过错误指针意外修改自身指令。因为多个进程可同时运行同一程序，所以又将文本段设为可共享，这样，==一份程序代码的拷贝可以映射到所有这些进程的虚拟地址空间中==。

- 初始化数据段包含显式初始化的全局变量和静态变量。当程序加载到内存时，从可执行文件中读取这些变量的值。

  >用户初始化数据段（user-initialized data segment）

- 未初始化数据段包含了未进行显式初始化的全局变量和静态变量。程序启动之前，系统将本段内所有内存初始化为 0。出于历史原因，此段常被称为 BSS 段，这源于老版本的汇编语言助记符“block started by symbol”。将经过初始化的全局变量和静态变量与未经初始化的全局变量和静态变量分开存放，其主要原因在于程序在磁盘上存储时，没有必要为未经初始化的变量分配存储空间。相反，可执行文件只需记录未初始化数据段的位置及所需大小，直到运行时再由程序加载器来分配这一空间。

  >零初始化数据段（zero-initialized data segment）。

- 栈（stack）是一个动态增长和收缩的段，由栈帧（stack frames）组成。系统会为每个当前调用的函数分配一个栈帧。栈帧中存储了函数的局部变量（所谓自动变量）、实参和返回值。

- 堆（heap）是可在运行时（为变量）动态进行内存分配的一块区域。堆顶端称作program break。





- ==size命令==可显示二进制可执行文件的文本段、初始化数据段、非初始化数据段（bss）的段大小。
- ![image-20221025190857095](%E5%85%AD%E3%80%81%E8%BF%9B%E7%A8%8B.assets/image-20221025190857095.png)



# ==虚拟内存管理==

![image-20221025193802668](%E5%85%AD%E3%80%81%E8%BF%9B%E7%A8%8B.assets/image-20221025193802668.png)

- 内核需要为每个进程维护一张页表。
- 页表中的每个条目要么指出一个虚拟页面在 RAM 中的所在位置，要么表明其当前驻留在磁盘上。
- 若进程欲访问的页面==目前***并未驻留***在物理内存中==，将会发生页面错误（page fault），内核即刻挂起进程的执行，同时==从磁盘中将该页面载入内存==。
- 若进程试图==访问的地址***并无页表条目与之对应***，那么进程将收到一个 SIGSEGV 信号==。
- 由于内核能够为进程分配和释放页（和页表条目），所以进程的有效虚拟地址范围在其生命周期中可以发生变化。



# 栈

- 在物理内存上，栈是向下增长的。
- 分配栈帧时，栈段的大小将增长。但出栈并不会释放内存。

