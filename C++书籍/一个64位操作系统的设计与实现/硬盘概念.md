# 扇区（sector）

扇区是磁盘最小的==物理存储单元==。



## 逻辑扇区与物理扇区

[(27 封私信 / 80 条消息) 逻辑扇区和物理扇区的对应关系有点不懂？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/67935624)

![img](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/v2-c1f894dca846db8b305c71a07adbe75b_720w.jpg)



# 簇/块（cluster）

由于操作系统无法对数目众多的扇区进行寻址，所以操作系统就将相邻的扇区组合在一起，形成一个簇，然后再对簇进行管理。每个簇可以包括2、4、8、16、32或64个扇区。==即扇区的集合==。

显然，==簇是操作系统所使用的逻辑概念，而非磁盘的物理特性==。



>簇是Windows（fat）文件系统的概念，在Linux叫块。





# FAT12

>- [(30条消息) FAT12文件系统_一起交流的博客-CSDN博客_fat12文件系统](https://blog.csdn.net/m0_37329910/article/details/88927673)
>- [FAT12_百度百科 (baidu.com)](https://baike.baidu.com/item/FAT12/4958604)



具体来说FAT12文件系统为1.44M的软盘设计。

- ==1.44M的软盘有2880个扇区，一个扇区有512个字节==；

- 那么FAT12文件系统的管理的空间大小就是2880 * 512 = 1474560个字节





## FAT12基础结构

FAT12文件系统将2880个扇区分成5个部分：

| 扇区位置 |   长度    |   内容   |
| :------: | :-------: | :------: |
|    0     |  1(512B)  |   MBR    |
|    1     | 9(4608B)  |  FAT表1  |
|    10    | 9(4608B)  |  FAT表2  |
|    19    | 14(9728B) | 根目录区 |
|    33    |    ---    |  数据区  |

![0_1329914901XICx](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/0_1329914901XICx-1663056236264-17.gif)

![img](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/v2-1c908247ddcfac45405ff5b7420a6138_r.jpg)



## MBR

MBR引导记录有512个字节，最后两个字节是0x55和0xAA；MBR记录的所有信息如下（储存数据附上常用值；部分数据没有给出）

![preview](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/v2-e275cab1f7bf671586f7032763086b91_r.jpg)

>- BPB_BytesPerSec：每扇区字节数，默认512。
>- BPB_SecPerClus：每簇的扇区数，默认1。
>- BPB_RootEntCnt：根目录文件数最大值，默认为224个，每个目录条目占用32B的空间。因此根目录的默认大小为$224*32B/512B=14$扇区
>- BPB_TotSec16：扇区总数=0xB40=2880个。
>- BPB_FATSz16：每个FAT占用的扇区数=0x9=9，即FAT1占用1—9逻辑扇区，FAT2占用10—18逻辑扇区。



![img](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5NjU0MTI3,size_16,color_FFFFFF,t_70.png)



## FAT1、FAT2表

这==两个表完全相同，FAT2表存在的目的就是为了修复FAT1表==。因此在实际操作的过程中可以将FAT1表在关机的时候赋值给FAT2即可。以后再说FAT表时，默认为FAT1表。



- 每个FAT项（FATEntry，12位），代表一个数据区中的簇。

- 第0个和第1个FAT项始终不使用，第2个FAT项开始表示数据区的每一个簇。

  也就是说，第2个FAT项表示数据区第一个簇，依次类推。前文说过，数据区的第一个簇的簇号是2，和这里相呼应。



- 关于解析FAT项：

  假设连续3个字节分别是如图所示：

  ![0_1329918772DOLx](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/0_1329918772DOLx-1663058721891-22.gif)

- FAT项的值含义：

  FAT项的值代表的是文件的下一个簇号，但如果值大于或等于0xFF8，则表示当前簇已经是文件的最后一个簇了。如果值为0xFF7，表示它是一个坏簇。



## 根目录区

根目录区的开始扇区号是19，它是由若干个目录条目(Directory Entry)组成，条目最多有BPB_RootEntCnt个，由于根目录区的大小是依赖于BPB_RootEntCnt的，所以长度不固定。

==根目录区由目录项（RootEntry，32位）构成，每一个目录项代表根目录中的一个文件索引==。

```c++
//创建 RootEntry 结构体类型
struct RootEntry
{
    char DIR_Name[11];
    uchar DIR_Attr;
    uchar reserve[10];
    ushort DIR_WrtTime;
    ushort DIR_WrtDate;
    ushort DIR_FstClus;
    uint DIR_FileSize;
};
```

![img](%E7%A1%AC%E7%9B%98%E6%A6%82%E5%BF%B5.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5NjU0MTI3,size_16,color_FFFFFF,t_70-1663055846578-7.png)



## 解析一个文件的流程

1. 查找根目录区：

   - 根目录区，始于19号扇区，即0x2600字节处。
   - 一个根目录项，占用32位。
   - ==根目录项，能给出文件开始的**簇号**==，设其为s。

2. 查找FAT表：

   - FAT项从0开始编码，但前两个(0和1)并不使用。

     > FAT[0]（FAT表项0）的低8位在数值上与BPB_Media字段保持一致，剩余位全部设置为1，故此FAT[0]的值是FF0h。在文件系统初始化期间，已经明确地将FAT[1]赋值为FFFh。

   - 找到编号为s的FAT项：

     该FAT项，给出了下一个簇的**簇号**，或是否结束及坏块。

     >如果值大于或等于0xFF8，则表示当前簇已经是文件的最后一个簇了。如果值为0xFF7，表示它是一个坏簇。

   