# ç›¸å…³èµ„æ–™

- è™šæ‹Ÿæœºè§„èŒƒï¼š[The JavaÂ® Virtual Machine Specification (oracle.com)](https://docs.oracle.com/javase/specs/jvms/se8/html/)



# æœ¬ç« æ¶‰åŠå†…å®¹

![image-20220420202403138](è¿è¡Œæ—¶æ•°æ®åŒº.assets/image-20220420202403138.png)

> æ­¤å›¾æ˜¯é’ˆå¯¹äºHotSpotè™šæ‹Ÿæœºè€Œè¨€çš„ã€‚







# è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°ä¸çº¿ç¨‹

JVMå†…å­˜å¸ƒå±€ï¼Œè§„å®šäº†Javaåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚

ä½†ä¸åŒçš„JVMï¼Œå¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨éƒ¨åˆ†å·®å¼‚ï¼ˆæ–¹æ³•åŒºï¼‰ã€‚æœ¬ç« ç»“åˆJVMè™šæ‹Ÿæœºè§„èŒƒï¼Œå¯¹**<u>ç»å…¸çš„JVMå†…å­˜å¸ƒå±€</u>**è¿›è¡Œæ¢è®¨ã€‚



## è¿è¡Œæ—¶æ•°æ®åŒºçš„å†…éƒ¨ç»“æ„

è¿è¡Œæ—¶æ•°æ®åŒºçš„ç»“æ„ï¼š

<img src=".\è¿è¡Œæ—¶æ•°æ®åŒº.assets\image-20220420204143873.png">

<img src="è¿è¡Œæ—¶æ•°æ®åŒº.assets/image-20220420203830609.png" alt="image-20220420203830609" style="zoom:80%;" />

- ç±»åŠ è½½å™¨ï¼šå°†classæ–‡ä»¶ï¼ŒåŠ è½½åˆ°å†…å­˜ä¸­ã€‚

- æ‰§è¡Œå¼•æ“ï¼šå¯¹<u>å­—èŠ‚ç æŒ‡ä»¤</u>è¿›è¡Œè§£é‡Šæ‰§è¡Œï¼Œå°†å…¶ç¿»è¯‘æˆ<u>æœºå™¨æŒ‡ä»¤</u>ã€‚

- æœ¬åœ°æ–¹æ³•æ¥å£ã€æœ¬åœ°æ–¹æ³•åº“ï¼šC/C++è¯­è¨€çš„æ¥å£æˆ–åº“

- è¿è¡Œæ—¶æ•°æ®åŒºï¼šå¯åˆ†ä¸ºï¼š

  - ç”±æ‰€æœ‰çº¿ç¨‹å…±äº«çš„æ•°æ®åŒºï¼šéšè™šæ‹Ÿæœºå¯åŠ¨è€Œåˆ›å»ºï¼Œéšè™šæ‹Ÿæœºé€€å‡ºè€Œé”€æ¯ï¼š

    - å †åŒº
    - å †å¤–å†…å­˜ï¼ˆ<u>æ°¸ä¹…ä»£,å…ƒç©ºé—´ï¼ˆæ–¹æ³•åŒºï¼‰</u>ã€ä»£ç ç¼“å­˜ï¼‰

    > ***æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´ï¼Œå¯ä»¥ç†è§£ä¸ºæ–¹æ³•åŒºçš„è½åœ°å®ç°***ã€‚
    >
    > ***åœ¨JDK8ä¹‹å***ï¼Œæ–¹æ³•åŒºæ¢åä¸ºå…ƒç©ºé—´ï¼Œä½¿ç”¨çš„æ˜¯***æœ¬åœ°å†…å­˜***

  - çº¿ç¨‹éš”ç¦»çš„æ•°æ®åŒºï¼šéšçº¿ç¨‹çš„å¼€å§‹å’Œç»“æŸè€Œåˆ›å»ºå’Œé”€æ¯

    - ç¨‹åºè®¡æ•°å™¨
    - æœ¬åœ°æ–¹æ³•æ ˆ
    - è™šæ‹Ÿæœºæ ˆ

> åƒåœ¾å›æ”¶ï¼Œä¸€èˆ¬æ˜¯é’ˆå¯¹å †åŒºå’Œæ–¹æ³•åŒºè€Œè¨€çš„ï¼Œå°¤å…¶æ˜¯å †åŒºã€‚

 

> æ¯ä¸ªJVMï¼Œä»…æœ‰ä¸€ä»½å•ä¾‹çš„Runtimeç±»å®ä¾‹ã€‚å¯¹åº”äºè¿è¡Œæ—¶æ•°æ®åŒºï¼Œå³è¿è¡Œæ—¶ç¯å¢ƒã€‚



## çº¿ç¨‹

- çº¿ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºé‡Œçš„æ‰§è¡Œå•å…ƒã€‚JVMå…è®¸ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚

- åœ¨HotSpot JVMé‡Œï¼Œ***æ¯ä¸ªçº¿ç¨‹éƒ½ä¸æ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ç›´æ¥æ˜ å°„***ï¼š

  - å½“ä¸€ä¸ªJavaçº¿ç¨‹å‡†å¤‡å¥½ï¼ˆPCã€NMSã€VMSã€ç¼“å­˜åˆ†é…ã€æœ¬åœ°å­˜å‚¨ç­‰ï¼‰æ‰§è¡Œä»¥åï¼Œæ­¤æ—¶ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ä¹ŸåŒæ—¶åˆ›å»ºã€‚å½“æœ¬åœ°çº¿ç¨‹åˆå§‹åŒ–æˆåŠŸä¹‹åï¼Œå®ƒå°±ä¼šè°ƒç”¨Javaçº¿ç¨‹ä¸­çš„run()æ–¹æ³•

  - å½“Javaçº¿ç¨‹æ‰§è¡Œç»ˆæ­¢åï¼Œæœ¬åœ°çº¿ç¨‹ä¼šè¢«å›æ”¶

    > å½“Javaçº¿ç¨‹å› æœªæ•è·çš„å¼‚å¸¸è€Œç»ˆæ­¢æ—¶ï¼Œå¦‚æœæ­¤çº¿ç¨‹ä¸ºæœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ï¼Œè™šæ‹Ÿæœºå°†é€€å‡º

- æ“ä½œç³»ç»Ÿè´Ÿè´£æ‰€æœ‰çº¿ç¨‹çš„å®‰æ’è°ƒåº¦ï¼Œä¼šå°†çº¿ç¨‹è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªå¯ç”¨çš„CPUä¸Šã€‚

- å¦‚æœä½¿ç”¨ jconsole æˆ–ä»»ä½•ä¸€ä¸ªè°ƒè¯•å·¥å…·ï¼Œä¼šå‘ç°å­˜åœ¨è®¸å¤šåå°çº¿ç¨‹ï¼ˆä¸åŒ…å«mainçº¿ç¨‹å’Œmainçº¿ç¨‹åˆ›å»ºçš„çº¿ç¨‹ï¼‰ã€‚è¿™äº›åå°ç³»ç»Ÿçº¿ç¨‹ï¼Œåœ¨Hotspot JVMä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªç±»åˆ«ï¼š

  1. è™šæ‹Ÿæœºçº¿ç¨‹ï¼š

     è¿™ç§çº¿ç¨‹çš„æ“ä½œæ˜¯éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹æ‰ä¼šå‡ºç°ã€‚è¿™äº›æ“ä½œå¿…é¡»åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å‘ç”Ÿçš„åŸå› æ˜¯ä»–ä»¬éƒ½éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹ï¼Œè¿™æ ·å †æ‰ä¸ä¼šå˜åŒ–ã€‚è¿™ç§çº¿ç¨‹çš„æ‰§è¡Œç±»å‹åŒ…æ‹¬â€œstop-the-worldâ€çš„åƒåœ¾æ”¶é›†ï¼Œçº¿ç¨‹æ ˆæ”¶é›†ï¼Œçº¿ç¨‹æŒ‚èµ·ä»¥åŠåå‘é”æ’¤é”€ã€‚

  2. å‘¨æœŸä»»åŠ¡çº¿ç¨‹ï¼š

     è¿™ç§çº¿ç¨‹æ˜¯æ—¶é—´å‘¨æœŸäº‹ä»¶çš„ä½“ç°ï¼ˆæ¯”å¦‚ä¸­æ–­ï¼‰ï¼Œä»–ä»¬ä¸€èˆ¬ç”¨äºå‘¨æœŸæ€§æ“ä½œçš„è°ƒåº¦æ‰§è¡Œã€‚

  3. GCçº¿ç¨‹ï¼š

     è¿™ç§çº¿ç¨‹å¯¹åœ¨JVMé‡Œä¸åŒç§ç±»çš„åƒåœ¾æ”¶é›†è¡Œä¸ºæä¾›äº†æ”¯æŒã€‚

  4. ç¼–è¯‘çº¿ç¨‹ï¼š

     è¿™ç§çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå°†å­—èŠ‚ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼ˆæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼‰

  5. ä¿¡å·è°ƒåº¦çº¿ç¨‹ï¼š

     è¿™ç§çº¿ç¨‹æ¥æ”¶ä¿¡å·å¹¶å‘é€ç»™JVMï¼Œåœ¨å®ƒå†…éƒ¨é€šè¿‡è°ƒç”¨é€‚å½“çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚



# PCå¯„å­˜å™¨

> ***JVMä¸­çš„PCå¯„å­˜å™¨ï¼Œæ˜¯å¯¹ç‰©ç†PCå¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿ***

> ***æ˜¯å”¯ä¸€ä¸€ä¸ªï¼Œåœ¨JVMè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•OutOfMemoryOutæƒ…å†µçš„åŒºåŸŸ***



- PCå¯„å­˜å™¨çš„ä½œç”¨ï¼š

  ç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼‰çš„åœ°å€ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–å¹¶æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤

- åœ¨ä»»ä½•æ—¶é—´ï¼Œä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ï¼ˆæ ˆé¡¶æ–¹æ³•ï¼‰ã€‚

  ç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰çº¿ç¨‹æ‰§è¡Œçš„Javaæ–¹æ³•çš„JVMæŒ‡ä»¤åœ°å€ï¼›

  æˆ–è€…ï¼Œè‹¥å½“å‰æ­£åœ¨æ‰§è¡Œnativeæ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼ï¼ˆundefinedï¼‰

- ä¸ºä»€ä¹ˆè¦ä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤åœ°å€ï¼š

  å› ä¸ºCPUéœ€è¦ä¸åœçš„è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼ŒCPUéœ€è¦çŸ¥é“æ¥ä¸‹æ¥æ‰§è¡Œå“ªæ¡æŒ‡ä»¤

## PCå¯„å­˜å™¨çš„ä¾‹å­

å¯¹å¦‚ä¸‹javaä»£ç ï¼š

```java
package chapter04;

public class PCRegisterTest {
    public PCRegisterTest() {
    }

    public static void main(String[] args) {
        int i = 10;
        int j = 20;
        int var10000 = i + j;
    }
}
```

æ‰§è¡Œåç¼–è¯‘ï¼š` javap -v .\PCRegisterTest.class`ï¼Œå°†å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

```
Classfile /D:/idea_workspace/juc_learn/out/production/juc_learn/chapter04/PCRegisterTest.class
  Last modified 2022å¹´4æœˆ22æ—¥; size 473 bytes
  MD5 checksum a01ae18f61395a307fc0ad2182b1e003
  Compiled from "PCRegisterTest.java"
public class chapter04.PCRegisterTest
  minor version: 0
  major version: 55
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #2                          // chapter04/PCRegisterTest
  super_class: #3                         // java/lang/Object
  interfaces: 0, fields: 0, methods: 2, attributes: 1
Constant pool:
   #1 = Methodref          #3.#21         // java/lang/Object."<init>":()V
   #2 = Class              #22            // chapter04/PCRegisterTest
   #3 = Class              #23            // java/lang/Object
   #4 = Utf8               <init>
   #5 = Utf8               ()V
   #6 = Utf8               Code
   #7 = Utf8               LineNumberTable
   #8 = Utf8               LocalVariableTable
   #9 = Utf8               this
  #10 = Utf8               Lchapter04/PCRegisterTest;
  #11 = Utf8               main
  #12 = Utf8               ([Ljava/lang/String;)V
  #13 = Utf8               args
  #14 = Utf8               [Ljava/lang/String;
  #15 = Utf8               i
  #16 = Utf8               I
  #17 = Utf8               j
  #18 = Utf8               k
  #19 = Utf8               SourceFile
  #20 = Utf8               PCRegisterTest.java
  #21 = NameAndType        #4:#5          // "<init>":()V
  #22 = Utf8               chapter04/PCRegisterTest
  #23 = Utf8               java/lang/Object
{
  public chapter04.PCRegisterTest();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 3: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lchapter04/PCRegisterTest;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=4, args_size=1
         0: bipush        10
         2: istore_1
         3: bipush        20
         5: istore_2
         6: iload_1
         7: iload_2
         8: iadd
         9: istore_3
        10: return
      LineNumberTable:
        line 6: 0
        line 7: 3
        line 8: 6
        line 9: 10
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      11     0  args   [Ljava/lang/String;
            3       8     1     i   I
            6       5     2     j   I
           10       1     3     k   I
}
SourceFile: "PCRegisterTest.java"
```

å…¶ä¸­ï¼š

- Codeä¸­ï¼š0,2,3...ä¸ºæŒ‡ä»¤åœ°å€ï¼ˆæˆ–ç§°åç§»åœ°å€ï¼‰





# è™šæ‹Ÿæœºæ ˆ

## è™šæ‹Ÿæœºæ ˆæ¦‚è¿°

- ***æ ˆæ˜¯è¿è¡Œæ—¶å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨å•ä½***

- Javaè™šæ‹Ÿæœºæ ˆæ˜¯ä»€ä¹ˆï¼Ÿ

  ***æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿æŒä¸€ä¸ªä¸ªçš„æ ˆå¸§ï¼Œå¯¹åº”ç€ä¸€ä¸ªä¸ªçš„Javaæ–¹æ³•è°ƒç”¨ã€‚***

- ä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œæ˜¯ç”±å¤šä¸ªæ ˆå¸§ç»„æˆçš„ã€‚

- ä¸€ä¸ªæ ˆå¸§ï¼Œå¯¹åº”ç€ä¸€ä¸ªjavaæ–¹æ³•ã€‚

  æ ˆå¸§ä¸­ï¼Œä¿å­˜ç€è¯¥æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€‚

  - è‹¥å±€éƒ¨å˜é‡ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ™ä¿å­˜çš„å°±æ˜¯å€¼æœ¬èº«ã€‚
  - è‹¥å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨æ•°æ®ç±»å‹ï¼Œåˆ™ä¿å­˜çš„å¯¹è±¡çš„å¼•ç”¨åœ°å€ã€‚å¯¹è±¡æœ¬èº«å­˜å‚¨äºå †åŒºã€‚

- ***å¯¹äºæ ˆæ¥è¯´ï¼Œä¸å­˜åœ¨çš„åƒåœ¾å›æ”¶çš„é—®é¢˜ã€‚ä½†å­˜åœ¨OutOfMemoryçš„å¯èƒ½***ã€‚





```java
package chapter05;

public class StackTest {

    public void methodA(){
        int i = 10;
        int j = 20;

        methodB();
    }

    public void methodB(){
        int m = 30;
        int n = 40;
    }

    public static void main(String[] args) {
        StackTest stackTest = new StackTest();
        stackTest.methodA();
    }
}
```

æ­¤mainçº¿ç¨‹å¯¹åº”çš„Javaè™šæ‹Ÿæœºæ ˆå¦‚ä¸‹ï¼š

![æœªå‘½åæ–‡ä»¶](C:\Users\G_xy\Downloads\æœªå‘½åæ–‡ä»¶.png)



## è™šæ‹Ÿæœºæ ˆçš„å¸¸è§å¼‚å¸¸ä¸è®¾ç½®æ ˆå¤§å°

Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ï¼Œå…è®¸Javaæ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„ï¼Œæˆ–è€…æ˜¯å›ºå®šä¸å˜çš„ã€‚

- ***è‹¥é‡‡ç”¨å›ºå®šå¤§å°çš„Javaè™šæ‹Ÿæœºæ ˆ***ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªçº¿ç¨‹çš„çš„Javaè™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºæ—¶ç‹¬ç«‹é€‰å®šã€‚å¦‚æœ***çº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡Javaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡***ï¼ŒJavaè™šæ‹Ÿæœºå°†æŠ›å‡º`StackOverflowError`å¼‚å¸¸

  ```java
  public class StackOverflowErrorTest {
  
      public static void main(String[] args) {
          main(args);
      }
  }
  // Exception in thread "main" java.lang.StackOverflowError
  ```

- ***è‹¥Javaè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‹“å±•ï¼Œå¹¶åœ¨å°è¯•æ‹“å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜***ï¼›***æˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆ***ï¼Œåˆ™Javaè™šæ‹Ÿæœºå°†æŠ›å‡º`OutOfMemory`å¼‚å¸¸



é€šè¿‡ä½¿ç”¨`å‚æ•° -Xss é€‰é¡¹`ï¼Œå¯ä»¥è®¾ç½®çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´ã€‚æ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦ã€‚

![image-20220422155453875](C:\Users\G_xy\AppData\Roaming\Typora\typora-user-images\image-20220422155453875.png)

```java
public class StackDeepTest {

    private static int count = 0;
    
    public static void recursion(){
        count++;
        recursion();
    }
    
    public static void main(String[] args) {
        try {
            recursion();
        }catch (Throwable e){
            System.out.println("deep of calling is:"+ count);
        }
    }
}
```



## è™šæ‹Ÿæœºæ ˆçš„å­˜å‚¨å•ä½â€”â€”æ ˆå¸§

- ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªæ–¹æ³•ã€‚å¯¹äºç€ä¸€ä¸ªè™šæ‹Ÿæœºæ ˆçš„å¤šä¸ªæ ˆå¸§

- åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚

  - å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆå³æ ˆé¡¶æ ˆå¸§ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼Œæ­¤æ ˆå¸§è¢«ç§°ä¸º`å½“å‰æ ˆå¸§ï¼ˆCurrent Frameï¼‰`ã€‚
  - ä¸å½“å‰æ ˆå¸§å¯¹åº”çš„æ–¹æ³•ï¼Œç§°ä¸º`å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰`
  - å®šä¹‰å½“å‰æ–¹æ³•çš„ç±»ï¼Œè¢«ç§°ä¸º`å½“å‰ç±»ï¼ˆCurrent Classï¼‰`

- ä¸åŒçº¿ç¨‹ä¹‹é—´æ‰€åŒ…å«çš„æ ˆå¸§ï¼Œæ˜¯ä¸èƒ½ç›¸äº’å¼•ç”¨çš„ã€‚å³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¸­å¼•ç”¨å¦ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§

- Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼š

  1. æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤
  2. è¿è¡Œæ—¶å‡ºç°æœªæ•è·çš„å¼‚å¸¸ï¼Œä»¥æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼è¿”å›

  ä¸ç®¡æ˜¯å“ªç§è¿”å›æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å‡ºæ ˆã€‚



### æ ˆå¸§çš„å†…éƒ¨ç»“æ„

æ¯ä¸ªæ ˆå¸§ä¸­ï¼Œå­˜å‚¨ç€ï¼š

- å±€éƒ¨å˜é‡è¡¨
- æ“ä½œæ•°æ ˆï¼ˆæˆ–ç§°è¡¨è¾¾å¼æ ˆï¼‰
- åŠ¨æ€é“¾æ¥ï¼ˆæˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ï¼‰
- æ–¹æ³•è¿”å›åœ°å€ï¼ˆæˆ–æ–¹æ³•æ­£å¸¸è¿”å›æˆ–å¼‚å¸¸é€€å‡ºçš„å®šä¹‰ï¼‰
- ä¸€äº›é™„åŠ ä¿¡æ¯

![image-20220503193849369](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220503193849369.png)



### å±€éƒ¨å˜é‡è¡¨(Local Variables)

- å±€éƒ¨å˜é‡è¡¨ï¼Œä¹Ÿæˆä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨ã€‚

- å…¶å®šä¹‰ä¸ºä¸€ä¸ª***æ•°å­—æ•°ç»„***ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡ã€‚

  å­˜å‚¨çš„æ•°æ®ç±»å‹åŒ…å«ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨ï¼ŒreturnAddressç±»å‹

- ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šçš„ï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤æ˜¯ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ã€‚

- å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å¤§å°ï¼Œæ˜¯åœ¨**ç¼–è¯‘é˜¶æ®µç¡®å®š**ä¸‹æ¥çš„ï¼Œå¹¶**ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesæ•°æ®é¡¹**ä¸­ã€‚

  åœ¨æ–¹æ³•çš„è¿æœŸé—´ï¼Œæ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„ã€‚



- å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ï¼Œåªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆã€‚

  åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨ï¼Œæ¥å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚

  å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿéšä¹‹é”€æ¯ã€‚



è­¬å¦‚ï¼š

- javaæ–¹æ³•ï¼š

  ```java
  public static void main(String[] args) {
      int i = 10;
      int j = 20;
      int k = i + j;
      Object obj = null;
  }
  ```

- å¯¹åº”çš„å±€éƒ¨å˜é‡è¡¨ï¼ˆæ‰§è¡Œ javap  -v xxx.classï¼‰ï¼š

  ```
  public static void main(java.lang.String[]);
      descriptor: ([Ljava/lang/String;)V
      flags: (0x0009) ACC_PUBLIC, ACC_STATIC
      Code:
        stack=2, locals=5, args_size=1
           0: bipush        10
           2: istore_1
           3: bipush        20
           5: istore_2
           6: iload_1
           7: iload_2
           8: iadd
           9: istore_3
          10: aconst_null
          11: astore        4
          13: return
        LineNumberTable:
          line 6: 0
          line 7: 3
          line 8: 6
          line 9: 10
          line 10: 13
        LocalVariableTable:
          Start  Length  Slot  Name   Signature
              0      14     0  args   [Ljava/lang/String;
              3      11     1     i   I
              6       8     2     j   I
             10       4     3     k   I
             13       1     4   obj   Ljava/lang/Object;
  ```

  > - å…³äºLineNumberTableï¼š
  >
  >   javaä»£ç è¡Œå·å’ŒCodeè¡Œå·çš„æ˜ å°„å…³ç³»ã€‚
  >
  > - å…³äºStartï¼š
  >
  >   Start+1 ä¸ºè¯¥å˜é‡å¼€å§‹æœ‰æ•ˆçš„Codeè¡Œå·ã€‚å­˜åœ¨Start+Length = Codeæ€»è¡Œå·çš„å…³ç³»
  >
  > - å…¶ä¸­å…³äºSignatureï¼š
  >
  >   - ä»¥`[`å¼€å¤´ï¼Œè¡¨ç¤ºä¸ºJavaçš„æ•°ç»„ç±»å‹
  >
  >   - ä»¥`L`å¼€å¤´ï¼Œè¡¨ç¤ºä¸ºå¼•ç”¨



#### Slot

- å±€éƒ¨å˜é‡è¡¨ï¼ˆä¸€æ•°å­—æ•°ç»„ï¼‰ï¼Œå…¶<font style="color:LightCOral;">æœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slotï¼ˆå˜é‡æ§½ï¼‰</font>

- åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­ï¼š

  - 32ä½ä»¥å†…çš„ç±»å‹ï¼Œå ç”¨ä¸€ä¸ªSlotã€‚ä¸»è¦æœ‰ï¼š
    - returnAddressç±»å‹
    - referenceç±»å‹
    - int
    - float
    - byteã€shortã€charã€booleanï¼ˆé0ä¸ºtrueï¼‰åœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºint
  - 64ä½çš„ç±»å‹ï¼Œå ç”¨ä¸¤ä¸ªSlotã€‚ä¸»è¦æœ‰ï¼š
    - long
    - double

- JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªç´¢å¼•ã€‚é€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¯¹åº”çš„å±€éƒ¨å˜é‡ã€‚

  > å½“è®¿é—®64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œé€šè¿‡å‰ä¸€ä¸ªç´¢å¼•è¿›è¡Œè®¿é—®ã€‚
  >
  > ä¾‹å¦‚é€šè¿‡ç´¢å¼•å€¼4è®¿é—®doubleå˜é‡q
  >
  > ![image-20220503204738145](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220503204738145.png)

- å±€éƒ¨å˜é‡è¡¨çš„åˆ†é…é¡ºåºï¼Œæ˜¯æŒ‰ç…§å˜é‡å®šä¹‰çš„é¡ºåºæ¥çš„ã€‚

  > ç‰¹åˆ«çš„ï¼Œå¯¹äºæ„é€ æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ï¼ˆéstaticæ–¹æ³•ï¼‰ï¼Œ***å¯¹è±¡å¼•ç”¨thisæ”¾åœ¨ç´¢å¼•ä¸º0çš„Slotå¤„***ã€‚

- <font style="color:LightCoral">Slotçš„é‡å¤åˆ©ç”¨</font>ï¼š

  æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨çš„æ§½ä½æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„ã€‚å¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨ä½œç”¨åŸŸä¹‹åå£°æ˜çš„æ–°çš„å±€éƒ¨å˜é‡ï¼Œå°±å¾ˆå¯èƒ½å¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ã€‚

  ä¾‹å¦‚ï¼š

  ```java
  public class SlotTest{
      public void localVarl(){
          int a = 0;
          int b = 0;
      }
      
      public void localVar2(){
          {
              int a = 0;
          }
          // æ­¤æ—¶bå°±ä¼šå¤ç”¨açš„æ§½ä½
          int b = 0;
      }
  }
  ```



å¤ä¹ ä¸€ä¸‹å˜é‡çš„åˆ†ç±»ï¼š

- æŒ‰æ•°æ®ç±»å‹åˆ†ï¼š

  - åŸºæœ¬æ•°æ®ç±»å‹
  - å¼•ç”¨æ•°æ®ç±»å‹

- æŒ‰ç…§åœ¨ç±»ä¸­å£°æ˜çš„ä½ç½®ï¼š

  - æˆå‘˜å˜é‡ï¼šéƒ½å­˜åœ¨é»˜è®¤åˆå§‹åŒ–å€¼

    - **ç±»å˜é‡ï¼ˆstaticä¿®é¥°ï¼‰**ï¼š

      1. linkingçš„prepareé˜¶æ®µï¼Œç»™ç±»å˜é‡é»˜è®¤èµ‹å€¼ï¼ˆèµ‹é›¶å€¼ï¼‰ã€‚

         > å½“ç„¶ï¼Œfinalä¿®é¥°çš„staticå˜é‡ï¼Œåœ¨æ­¤å·²ç»æ˜¾å¼èµ‹åˆå€¼

      2. åœ¨linkingçš„initialé˜¶æ®µï¼Œç»™ç±»å˜é‡æ˜¾å¼èµ‹åˆå€¼ã€‚

    - **å®ä¾‹å˜é‡ï¼ˆæ— staticä¿®é¥°ï¼‰**ï¼š

      éšç€å¯¹è±¡çš„åˆ›å»ºï¼Œåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼ã€‚

  - å±€éƒ¨å˜é‡ï¼š

    - å¿…é¡»æ˜¾å¼èµ‹å€¼ï¼Œä¸å­˜åœ¨é»˜è®¤èµ‹å€¼ã€‚

    

  

### æ“ä½œæ•°æ ˆ(Operand Stack)

- æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ ˆå¸§ä¸­ï¼Œé™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªåè¿›å…ˆå‡ºçš„***æ“ä½œæ•°æ ˆ***ï¼ˆä¹Ÿå¯ä»¥ç§°ä¸ºè¡¨è¾¾å¼æ ˆï¼‰ã€‚

- æ“ä½œæ•°æ ˆï¼š

  åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼ˆå³***å…¥æ ˆæˆ–å‡ºæ ˆ***ï¼‰ã€‚

  - æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ ˆä¸­ï¼›å…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°ä»æ ˆä¸­å–å‡ºï¼Œä½¿ç”¨å®ƒä»¬è®¡ç®—å‡ºç»“æœï¼Œå¹¶å°†ç»“æœå…¥æ ˆã€‚

  - ä¾‹å¦‚ï¼šæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œã€‚

    ![image-20220513220509102](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513220509102.png)

- æ“ä½œæ•°æ ˆï¼Œ***ä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´***ã€‚åŸºäºæ•°ç»„å®ç°ã€‚
- æ“ä½œæ•°æ ˆï¼Œå°±æ˜¯JVMæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºã€‚å½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§éšä¹‹è¢«åˆ›å»ºï¼Œ**æ­¤æ—¶è¯¥æ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„**ã€‚
- æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ã€‚å…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦ç¡®å®šäºç¼–è¯‘æ—¶æœŸï¼Œä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§ä¸­ï¼Œä¸ºstackçš„å€¼ã€‚
- æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä»»æ„çš„Javaæ•°æ®ç±»å‹ã€‚
  - 32bitçš„ç±»å‹ï¼Œå ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦ã€‚
  - 64bitçš„ç±»å‹ï¼Œå ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦ã€‚

- ***å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦è¿”å›å€¼ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­***ã€‚***å¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸ºä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤***ã€‚
- æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹ï¼Œå¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ã€‚
  1. ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µè¿›è¡ŒéªŒè¯ï¼›
  2. åŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µï¼Œè¿›è¡Œå†æ¬¡éªŒè¯ã€‚
- æˆ‘ä»¬å¸¸è¯´çš„Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“ï¼Œå…¶ä¸­çš„æ ˆå°±æ˜¯æ“ä½œæ•°æ ˆã€‚



ä¾‹å¦‚ï¼š

- javaä»£ç ï¼š

  ```java
  public void testAddOperation() {
      byte i = 15;
      int j = 8;
      int k = i + j;
  }
  ```

- å¯¹åº”çš„å­—èŠ‚ç æŒ‡ä»¤ï¼š

  ```java
  public void testAddOperation();
      descriptor: ()V
      flags: (0x0001) ACC_PUBLIC
      Code:
        stack=2, locals=4, args_size=1
           0: bipush        15
           2: istore_1
           3: bipush        8
           5: istore_2
           6: iload_1
           7: iload_2
           8: iadd
           9: istore_3
          10: return
        LineNumberTable:
          line 6: 0
          line 7: 3
          line 8: 6
          line 9: 10
        LocalVariableTable:
          Start  Length  Slot  Name   Signature
              0      11     0  this   Lchapter05/OperationStackTest;
              3       8     1     i   B
              6       5     2     j   I
             10       1     3     k   I
  ```



#### ä»£ç è¿½è¸ª

```java
0: bipush        15
2: istore_1
3: bipush        8
5: istore_2
6: iload_1
7: iload_2
8: iadd
9: istore_3
10: return
```

1. æ‰§è¡Œ`bipush 15`ï¼šå°†15å…¥æ ˆ

   ![image-20220513223629876](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513223629876.png)

   >æ³¨æ„ï¼šbyteã€shortã€charã€booleanï¼ˆé0ä¸ºtrueï¼‰åœ¨å­˜å…¥å±€éƒ¨å˜é‡è¡¨å‰è¢«è½¬æ¢ä¸ºint

2. æ‰§è¡Œ`istore_1`ï¼šå°†æ ˆé¡¶æ•°æ®ï¼Œè½¬å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®

   ![image-20220513223754084](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513223754084.png)

   > è¯´æ˜ï¼šistore_1è¡¨ç¤ºå­˜æ”¾åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®ã€‚0ä½ç½®è¢«thiså ç”¨äº†ã€‚

3. æ‰§è¡Œ`bipush 8`

   ![image-20220513224019135](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513224019135.png)

4. æ‰§è¡Œ`istore_2`

   ![image-20220513224050477](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513224050477.png)

5. æ‰§è¡Œ`iload_1`ï¼šå°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å€¼ï¼Œå­˜å…¥æ“ä½œæ•°æ ˆ

   ![image-20220513224233955](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513224233955.png)

6. æ‰§è¡Œ`iload_2`ï¼šå°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º2çš„å€¼ï¼Œå­˜å…¥æ“ä½œæ•°æ ˆ

   ![image-20220513224316189](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513224316189.png)

7. æ‰§è¡Œ`iadd`ï¼šæ‰§è¡Œå¼•æ“å°†å­—èŠ‚ç æŒ‡ä»¤ç¿»è¯‘ä¸ºæœºå™¨æŒ‡ä»¤ï¼Œç”±CPUå®ŒæˆåŠ æ³•æ“ä½œã€‚æ‰§è¡Œå¼•æ“å°†ç»“æœå…¥æ ˆ

   ![image-20220513224456212](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513224456212.png)

8. æ‰§è¡Œ`istore_3`ï¼šå°†æ ˆé¡¶å…ƒç´ å­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3çš„ä½ç½®

   ![image-20220513224544215](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220513224544215.png)

9. æ‰§è¡Œ`return`





è§‚å¯Ÿå‡½æ•°çš„è°ƒç”¨åŠ**è¿”å›å€¼**ï¼š

```java
public int getANum() {
    return 100;
}
public int getANum();
    descriptor: ()I
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: bipush        100
         2: ireturn
      LineNumberTable:
        line 6: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       3     0  this   Lchapter05/OperationStackTest;


public void testReturn() {
    int i = getANum();
    int j = 10;
}
public void testReturn();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=3, args_size=1
         0: aload_0	// è·å–ä¸Šä¸€ä¸ªæ ˆå¸§è¿”å›çš„ç»“æœï¼Œå°†å…¶ä¿å­˜åœ¨æ“ä½œæ•°æ ˆ
         1: invokevirtual #2                  // Method getANum:()I
         4: istore_1
         5: bipush        10
         7: istore_2
         8: return
      LineNumberTable:
        line 10: 0
        line 11: 5
        line 12: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  this   Lchapter05/OperationStackTest;
            5       4     1     i   I
            8       1     2     j   I

```



#### æ ˆé¡¶ç¼“å­˜æŠ€æœ¯(Top-Of-Stack-Cashing)

- JVMæ˜¯åŸºäºæ ˆå¼æ¶æ„çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨çš„æ˜¯é›¶åœ°å€æŒ‡ä»¤ã€‚

  æŒ‡ä»¤æ›´ç®€çŸ­ï¼Œä½†æŒ‡ä»¤é›†çš„åŸºæ•°æ¯”è¾ƒå¤§ã€‚æ„å‘³ç€éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾æ¬¡æ•°å’Œå†…å­˜è¯»å†™æ¬¡æ•°ã€‚

- ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œé¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»å†™æ“ä½œä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚

- ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMçš„è®¾è®¡è€…ï¼Œæå‡ºäº†æ ˆé¡¶ç¼“å­˜æŠ€æœ¯ï¼Œ***å°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ä¸­ï¼Œä»¥æ­¤å°†å…¶å¯¹å†…å­˜çš„è¯»å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡***ã€‚



### åŠ¨æ€é“¾æ¥çš„ç†è§£ä¸å¸¸é‡æ± çš„ä½œç”¨

> åŠ¨æ€é“¾æ¥ï¼ˆæˆ–ç§°**æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨**ï¼‰ï¼ˆæ˜¯å¼•ç”¨ï¼Œè¯¥å¼•ç”¨æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æŸä¸ªæ–¹æ³•ï¼‰

- æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨ï¼Œéƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘äº†è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§å¯¹åº”æ–¹æ³•çš„å¼•ç”¨ã€‚

  åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç ï¼Œèƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥ã€‚æ¯”å¦‚ invokedynamic æŒ‡ä»¤

- å½“Javaæºæ–‡ä»¶è¢«ç¼–è¯‘ä¸ºå­—èŠ‚ç æ–‡ä»¶æ—¶ï¼Œ**æ‰€æœ‰çš„ï¼ˆç±»æˆ–æˆå‘˜ï¼‰å˜é‡å’Œæ–¹æ³•å¼•ç”¨**ï¼Œ**éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨(Symbolic Reference)ä¿å­˜åœ¨classæ–‡ä»¶çš„å¸¸é‡æ± ä¸­**ã€‚

  > åŠ¨æ€é“¾æ¥çš„ä½œç”¨ï¼Œæ˜¯å°†è¿™äº›ç¬¦å·å¼•ç”¨ï¼ˆå¦‚#3ï¼‰ï¼Œ**è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨**

  ```java
  public class DynamicLinkingTest {
  
      int num = 10;
  
      public void methodA() {
      }
  
      public void methodB() {
          methodA();
          num++;
      }
  }
  ```

  ```java
  Constant pool:
     #1 = Methodref          #5.#19         // java/lang/Object."<init>":()V
     #2 = Fieldref           #4.#20         // chapter05/DynamicLinkingTest.num:I
     #3 = Methodref          #4.#21         // chapter05/DynamicLinkingTest.methodA:()V
     #4 = Class              #22            // chapter05/DynamicLinkingTest
     #5 = Class              #23            // java/lang/Object
     #6 = Utf8               num
     #7 = Utf8               I
     #8 = Utf8               <init>
     #9 = Utf8               ()V
    #10 = Utf8               Code
    #11 = Utf8               LineNumberTable
    #12 = Utf8               LocalVariableTable
    #13 = Utf8               this
    #14 = Utf8               Lchapter05/DynamicLinkingTest;
    #15 = Utf8               methodA
    #16 = Utf8               methodB
    #17 = Utf8               SourceFile
    #18 = Utf8               DynamicLinkingTest.java
    #19 = NameAndType        #8:#9          // "<init>":()V
    #20 = NameAndType        #6:#7          // num:I
    #21 = NameAndType        #15:#9         // methodA:()V
    #22 = Utf8               chapter05/DynamicLinkingTest
    #23 = Utf8               java/lang/Object
        
    public void methodB();
      descriptor: ()V
      flags: (0x0001) ACC_PUBLIC
      Code:
        stack=3, locals=1, args_size=1
           0: aload_0
           1: invokevirtual #3                  // Method methodA:()V
           4: aload_0
           5: dup
           6: getfield      #2                  // Field num:I
           9: iconst_1
          10: iadd
          11: putfield      #2                  // Field num:I
          14: return
  ```

  

### æ–¹æ³•çš„è°ƒç”¨

- åœ¨JVMä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè¢«è°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼Œä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶æœ‰å…³ï¼š

  - é™æ€é“¾æ¥ï¼š

    å½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œ**å¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜**ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¸ºé™æ€é“¾æ¥ã€‚

  - åŠ¨æ€é“¾æ¥ï¼š

    **å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚

- å¯¹åº”çš„æ–¹æ³•ç»‘å®šæœºåˆ¶ä¸ºï¼š

  ***ç»‘å®šï¼Œæ˜¯ä¸€ä¸ªæ–¹æ³•ã€å­—æ®µã€æˆ–è€…ç±»çš„ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œæ­¤è¿‡ç¨‹ä»…å‘ç”Ÿä¸€æ¬¡***ã€‚

  - æ—©æœŸç»‘å®šï¼ˆå¯¹åº”äºé™æ€é“¾æ¥ï¼‰
  - æ™šæœŸç»‘å®šï¼ˆå¯¹åº”äºåŠ¨æ€é“¾æ¥ï¼‰



```java
class Animal {
    public void eat() {
        System.out.println("animal eat");
    }
}

interface HuntAble {
    void hunt();
}

class Dog extends Animal implements HuntAble {
    @Override
    public void eat() {
        System.out.println("dog eat");
    }

    @Override
    public void hunt() {
        System.out.println("dog hunt");
    }
}

class Cat extends Animal implements HuntAble {

    public Cat(){
        super();    // è¡¨ç°ä¸ºæ—©æœŸç»‘å®š
    }

    public Cat(String name){
        this();     // è¡¨ç°ä¸ºæ—©æœŸç»‘å®š
    }

    @Override
    public void eat() {
        System.out.println("cat eat");
        super.eat();    // è¡¨ç°ä¸ºæ—©æœŸç»‘å®š
    }

    @Override
    public void hunt() {
        System.out.println("cat hunt");
    }
}

public class AnimalTest {
    public void doEat(Animal animal) {
        animal.eat();    // è¡¨ç°ä¸ºæ™šæœŸç»‘å®š
    }

    public void doHunt(HuntAble huntAble) {
        huntAble.hunt(); // è¡¨ç°ä¸ºæ™šæœŸç»‘å®š
    }
}
```

```java
// Catç±»

  public chapter05.Cat();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method chapter05/Animal."<init>":()V
         4: return
      LineNumberTable:
        line 28: 0
        line 29: 4
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lchapter05/Cat;

  public chapter05.Cat(java.lang.String);
    descriptor: (Ljava/lang/String;)V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=2, args_size=2
         0: aload_0
         1: invokespecial #2                  // Method "<init>":()V
         4: return
      LineNumberTable:
        line 32: 0
        line 33: 4
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lchapter05/Cat;
            0       5     1  name   Ljava/lang/String;

  public void eat();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #4                  // String cat eat
         5: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: aload_0
         9: invokespecial #6                  // Method chapter05/Animal.eat:()V
        12: return
      LineNumberTable:
        line 37: 0
        line 38: 8
        line 39: 12
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      13     0  this   Lchapter05/Cat;
```

```java
// AnimalTestç±»

public void doEat(chapter05.Animal);
    descriptor: (Lchapter05/Animal;)V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=2, args_size=2
         0: aload_1
         1: invokevirtual #2                  // Method chapter05/Animal.eat:()V
         4: return
      LineNumberTable:
        line 40: 0
        line 41: 4
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lchapter05/AnimalTest;
            0       5     1 animal   Lchapter05/Animal;

  public void doHunt(chapter05.HuntAble);
    descriptor: (Lchapter05/HuntAble;)V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=2, args_size=2
         0: aload_1
         1: invokeinterface #3,  1            // InterfaceMethod chapter05/HuntAble.hunt:()V
         6: return
      LineNumberTable:
        line 44: 0
        line 45: 6
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       7     0  this   Lchapter05/AnimalTest;
            0       7     1 huntAble   Lchapter05/HuntAble;
```

æ€»ç»“å¦‚ä¸‹ï¼š

- `invokespecial`æŒ‡ä»¤ï¼šå¯¹åº”äºæ—©æœŸç»‘å®š
- `invokevirtual`æŒ‡ä»¤ï¼šå¯¹åº”äºæ™šæœŸç»‘å®š



#### è™šæ–¹æ³•ä¸éè™šæ–¹æ³•

- åœ¨C++ä¸­ï¼Œéœ€è¦æ˜¾å¼ä½¿ç”¨å…³é”®å­—virtualæ¥å®šä¹‰è™šå‡½æ•°ã€‚

- åœ¨Javaä¸­ï¼Œæ–¹æ³•é»˜è®¤æ˜¯è™šå‡½æ•°ï¼Œæ”¯æŒå¤šæ€è°ƒç”¨ã€‚

  å½“ä¸å¸Œæœ›æŸä¸ªæ–¹æ³•å…·æœ‰è™šå‡½æ•°çš„ç‰¹å¾æ—¶ï¼Œå¯ä»¥ä½¿ç”¨finalå…³é”®å­—ã€‚



- å…¸å‹çš„éè™šæ–¹æ³•ï¼ˆå³å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œå¯¹åº”äºæ—©æœŸç»‘å®šï¼‰ï¼š

  - é™æ€éæŠ½è±¡æ–¹æ³•ï¼ˆå­ç±»ä»…å¯é‡å†™çˆ¶ç±»æœªå®ç°çš„æŠ½è±¡æ–¹æ³•ï¼‰
  - ç§æœ‰æ–¹æ³•
  - finalæ–¹æ³•
  - å®ä¾‹æ„é€ å™¨
  - çˆ¶ç±»çš„æ–¹æ³•

  > ç®€å•çš„è¯´ï¼Œå°±æ˜¯ä¸æ”¯æŒé‡å†™çš„æ–¹æ³•ï¼ˆæˆ–ä¸æ”¯æŒå¤šæ€è¯­æ³•çš„æ–¹æ³•ï¼‰ã€‚

- å…¶ä»–æ–¹æ³•éƒ½æ˜¯è™šæ–¹æ³•ï¼ˆå³ä»…å¯åœ¨è¿è¡Œæ—¶ç¡®å®šï¼Œå¯¹åº”äºæ™šæœŸç»‘å®šï¼‰

> â€œç¡®å®šâ€ æŒ‡çš„æ˜¯ï¼šç¡®å®šå°†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•æ˜¯å“ªä¸ªç±»çš„æ–¹æ³•



#### æ–¹æ³•è°ƒç”¨çš„ç›¸å…³æŒ‡ä»¤

- æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š

  - å¯¹åº”äºéè™šæ–¹æ³•ï¼š

    - `invokestatic`ï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬
    - `invokespecial`ï¼šè°ƒç”¨\<init>æ–¹æ³•ã€ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬ã€‚

  - å¯¹åº”äºè™šæ–¹æ³•ï¼š

    - `invokevirtural`ï¼šè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•ï¼ˆå’Œfinalæ–¹æ³•ï¼‰

      > æ³¨æ„ï¼šè‹¥çˆ¶ç±»ä¸­å­˜åœ¨finalçš„æˆå‘˜æ–¹æ³•ï¼Œåœ¨æ­¤ç±»ä¸­è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼š
      >
      > - è‹¥æ— super.ï¼šä½¿ç”¨invokevirturalæŒ‡ä»¤
      > - è‹¥æœ‰super.ï¼šä½¿ç”¨invokespecialæŒ‡ä»¤

    - `invokeinterface`ï¼šè°ƒç”¨æ¥å£æ–¹æ³•

- åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š

  - invokedynamicï¼šåŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œã€‚

    >- åœ¨JDK7ä¸­ï¼Œä¸ºå®ç° â€œåŠ¨æ€ç±»å‹è¯­è¨€â€ä¸ºå¢åŠ 
    >
    >  >- åŠ¨æ€ç±»å‹è¯­è¨€ï¼š
    >  >
    >  >  å¯¹ç±»å‹çš„æ£€æŸ¥åœ¨ç¼–è¯‘æœŸé—´ã€‚ä¹Ÿå°±æ˜¯**åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯**ã€‚
    >  >
    >  >- é™æ€ç±»å‹è¯­è¨€ï¼š
    >  >
    >  >  å¯¹ç±»å‹çš„æ£€æŸ¥åœ¨è¿è¡Œæ—¶æœŸã€‚ä¹Ÿå°±æ˜¯**åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯**ã€‚
    >
    >- åœ¨JDK8ä¸­ï¼ŒLambdaè¡¨è¾¾å¼å°†ç”ŸæˆinvokedynamicæŒ‡ä»¤



#### æ–¹æ³•é‡å†™çš„æœ¬è´¨

Javaè¯­è¨€ä¸­ï¼Œæ–¹æ³•é‡å†™çš„æœ¬è´¨ï¼š

1. æ‰¾åˆ°æ“ä½œæ•°æ ˆæ ˆé¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°ä½œ Cã€‚

2. å¦‚æœåœ¨ç±»å‹ C ä¸­ï¼Œæ‰¾åˆ°äºå¸¸é‡ä¸­çš„æè¿°ç¬¦å’Œç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒ:

   - è‹¥æ ¡éªŒé€šè¿‡ï¼šè¿”å›è¯¥æ–¹æ³•çš„ç›´æ¥é¥®ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸ

   - è‹¥æ ¡éªŒå¤±è´¥ï¼šè¿”å›`java.lang.IlleaglAccessError`å¼‚å¸¸

     > ä¸€èˆ¬çš„ï¼Œè‹¥æ— æƒé™è®¿é—®ï¼Œä¼šåœ¨ç¼–è¯‘é˜¶æ®µå¼•èµ·ç¼–è¯‘å™¨å¼‚å¸¸ã€‚
     >
     > è‹¥åœ¨è¿è¡Œæ—¶æŠ›å‡ºæ­¤å¼‚å¸¸ï¼Œè¯´æ˜è¯¥ç±»å‘ç”Ÿäº†ä¸å¯å…¼å®¹çš„æ”¹å˜ã€‚

3. å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ï¼Œä»ä¸‹å¾€ä¸Šä»¥æ¬¡å¯¹ C çš„å„ä¸ªçˆ¶ç±»ï¼Œè¿›è¡Œç¬¬äºŒæ­¥çš„æœç´¢å’ŒéªŒè¯é˜¶æ®µã€‚

4. å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼ŒæŠ›å‡º`java.lang.AbstratMethodError`å¼‚å¸¸



#### è™šæ–¹æ³•è¡¨

åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ä¸­ï¼Œä¼šå¾ˆé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼ˆinvokevirtualï¼‰ï¼Œå¦‚æœåœ¨æ¯æ¬¡åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡æ–¹æ³•ï¼Œä¼šæ¯”è¾ƒå½±å“æ‰§è¡Œæ•ˆç‡ã€‚

- ä¸ºæå‡æ€§èƒ½ï¼Œ***JVMåœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œä½¿ç”¨ç´¢å¼•è¡¨ä»£æ›¿æŸ¥æ‰¾***ã€‚

  > æ³¨æ„ï¼šéè™šæ–¹æ³•ä¸ä¼šå‡ºç°åœ¨è¡¨ä¸­ã€‚

- æ¯ä¸ªç±»ä¸­ï¼Œéƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚

- **è™šæ–¹æ³•è¡¨çš„åˆ›å»ºæ—¶æœº**ï¼š

  1. è™šæ–¹æ³•è¡¨åœ¨**ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µï¼ˆçš„è§£æç¯èŠ‚ï¼‰**è¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼›
  2. ç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæ¯•åï¼ŒJVMä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚

![image-20220514224055781](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220514224055781.png)



### æ–¹æ³•è¿”å›åœ°å€(Return Address)

- æ–¹æ³•è¿”å›åœ°å€ï¼Œ***å­˜å‚¨çš„æ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„PCå¯„å­˜å™¨çš„å€¼***

-  ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

  1. æ­£å¸¸æ‰§è¡Œç»“æŸ

     è°ƒç”¨è€…çš„PCå¯„å­˜å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€åœ°å€ï¼ˆåŠè°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚

     > Tipï¼š
     >
     > - ireturnæŒ‡ä»¤ï¼šå½“è¿”å›å€¼æ˜¯booleanã€byteã€charã€shortã€int
     > - lreturnæŒ‡ä»¤
     > - dreturnæŒ‡ä»¤
     > - aretrunæŒ‡ä»¤ï¼šå½“è¿”å›å€¼æ˜¯å¼•ç”¨ç±»å‹
     > - returnæŒ‡ä»¤ï¼šå£°æ˜ä¸ºvoidçš„æ–¹æ³•ã€æ„é€ å™¨æ–¹æ³•ã€ç±»å’Œæ¥å£çš„\<clinit>æ–¹æ³•

  2. å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º

     è¿”å›åœ°å€è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šã€‚æ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚

     **é€šè¿‡å¼‚å¸¸çš„é€€å‡ºï¼Œä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•è¿”å›å€¼**ã€‚

  > æ€»çš„æ¥è¯´ï¼Œæ— æ³•ä»¥ä½•ç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½ä¼šè¿”å›åˆ°è¯¥æ–¹æ³•è¢«æ‰ç”¨çš„ä½ç½®ã€‚

- æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰æ ˆå‡ºæ ˆçš„è¿‡ç¨‹ï¼š

  éœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å¹¶å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆï¼Œè®¾ç½®PCå¯„å­˜å™¨çš„å€¼ã€‚ä»è€Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œã€‚



### æ ˆå¸§ä¸­çš„ä¸€äº›é™„åŠ ä¿¡æ¯

æ ˆå¸§ä¸­å…è®¸æºå¸¦**ä¸Javaè™šæ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„ä»¶ä¿¡æ¯**ã€‚ï¼ˆå³ä¾èµ–äºå…·ä½“çš„JVMå®ç°ï¼‰ã€‚

ä¾‹å¦‚ï¼šå¯¹ç¨‹åºè°ƒè¯•æä¾›çš„æ”¯æŒä¿¡æ¯ã€‚



## è™šæ‹Ÿæœºæ ˆç›¸å…³çš„é¢è¯•é¢˜

- ä¸¾ä¾‹æ ˆæº¢å‡ºçš„æƒ…å†µï¼ˆStackOverflowErrorï¼‰

  é€šè¿‡-Xssè®¾ç½®è™šæ‹Ÿæœºæ ˆçš„å¤§å°è§£å†³æ­¤é—®é¢˜

- åƒåœ¾å›æ”¶æ˜¯å¦ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿæœºæ ˆï¼Ÿ

  ä¸ä¼šã€‚

- æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡ï¼Œæ˜¯å¦å…·æœ‰çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ

  å…·ä½“æƒ…å†µéœ€å…·ä½“åˆ†æï¼ˆè€ƒè™‘é€ƒé€¸åˆ†æï¼‰ã€‚



## æ€»ç»“

![image-20220516184845196](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516184845196.png)





# æœ¬åœ°æ–¹æ³•æ ˆ

- Javaè™šæ‹Ÿæœºæ ˆç”¨äºç®¡ç†Javaæ–¹æ³•çš„è°ƒç”¨ï¼›è€Œ**æœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨**ã€‚
- **æœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„**ã€‚
- å…è®¸è¢«å®ç°ä¸ºå›ºå®šçš„æˆ–è€…æ˜¯å¯æ‹“å±•å†…å­˜å¤§å°ï¼š
  - å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…å‡ºæœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJVMå°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸
  - å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯åŠ¨æ€æ‹“å±•ï¼Œä½†åœ¨å°è¯•æ‹“å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼›æˆ–è´¼åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œå°†æŠ›å‡ºOutOfMemoryå¼‚å¸¸ã€‚
- æœ¬åœ°æ–¹æ³•ï¼Œæ˜¯ç”¨Cè¯­è¨€å®ç°çš„ã€‚
- å®ƒçš„å…·ä½“åšæ³•ä¸ºï¼š**Native Method Stackä¸­ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨ Execution Engine æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“**ã€‚

- å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ª**æœ¬åœ°æ–¹æ³•**æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—JVMé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒ**å’ŒJVMå°†æ‹¥æœ‰åŒæ ·çš„æƒé™**ï¼š

  1. æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£ï¼Œæ¥è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒº
  2. å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨
  3. ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜

- å¹¶ä¸æ˜¯æ‰€æœ‰çš„JVMå®ç°éƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚

  Javaè™šæ‹Ÿæœºè§„èŒƒï¼Œå¹¶æ²¡æœ‰æ˜ç¡®è§„å®šæœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰ã€‚

- **åœ¨HotSpot JVMä¸­ï¼Œæœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€**ã€‚



# å †åŒº

## å †åŒºçš„æ ¸å¿ƒæ¦‚è¿°

- ä¸€ä¸ªJVMå®ä¾‹ï¼Œåªå­˜åœ¨ä¸€å—å †å†…å­˜ã€‚å †ä¹Ÿæ˜¯Javaå†…å­˜ç®¡ç†çš„æ ¸å¿ƒåŒºåŸŸã€‚

- Javaå †åŒºåœ¨JVMå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œå…¶ç©ºé—´å¤§å°åŒæ—¶è¢«ç¡®å®šï¼ˆå¯ä»¥é€šè¿‡å‚æ•°è®¾ç½®ï¼‰ã€‚

- ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹è§„å®šï¼Œ**å †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„**ã€‚

- **æ‰€æœ‰çš„çº¿ç¨‹å…±äº«Javaå †ï¼Œ*ä½†å¯ä»¥ä¸ºçº¿ç¨‹åˆ’åˆ†ç§æœ‰çš„ç¼“å†²åŒº***ï¼ˆThread Local Allocaton Bufferï¼ŒTLABï¼‰

- ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å¯¹Javaå †çš„æè¿°ï¼š

  **æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„ï¼Œéƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Š**ã€‚

  åœ¨æ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–æ•°ç»„åœ¨å †åŒºä¸­çš„ä½ç½®ã€‚

  > ä½†äº‹å®ä¸Šï¼Œæœªå‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡ï¼Œå¯ä»¥åˆ†é…åœ¨æ ˆä¸Šã€‚ 

- å…³äºå›æ”¶ï¼š

  - å †ä¸Šåˆ†é…çš„ï¼šæ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šç«‹åˆ»è¢«ç§»é™¤ã€‚ä»…åœ¨åƒåœ¾æ”¶é›†æ—¶æ‰è¢«ç§»é™¤ã€‚
  - æ ˆä¸Šåˆ†é…çš„ï¼šéšç€æ ˆå¸§çš„å‡ºæ ˆè€Œé”€æ¯ã€‚

![image-20220516202828675](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516202828675.png)



## å †çš„å†…å­˜åˆ’åˆ†

ç°ä»£åƒåœ¾æ”¶é›†å™¨ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯åŸºäº**åˆ†ä»£æ”¶é›†ç†è®ºè®¾è®¡**ã€‚å †ç©ºé—´åˆ’åˆ†ä¸ºï¼š

- åœ¨Java7åŠä¹‹å‰ï¼Œå †å†…å­˜**åœ¨é€»è¾‘ä¸Š**è¢«åˆ’åˆ†ä¸ºï¼š

  - æ–°ç”ŸåŒº
    - EdenåŒº
    - SurvivoråŒº
  - è€å¹´åŒº
  - **æ°¸ä¹…åŒº**

  ![image-20220516204458202](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516204458202.png)

- åœ¨JDK8åŠä¹‹åï¼Œå †å†…å­˜**åœ¨é€»è¾‘ä¸Š**åˆ’åˆ†ä¸ºï¼š

  - æ–°ç”ŸåŒº
    - EdenåŒº
    - SurvivoråŒº
  - è€å¹´åŒº
  - **å…ƒç©ºé—´**(Meta Space)

  ![image-20220516204910999](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516204910999.png)

> äº‹å®ä¸Šï¼Œæ°¸ä¹…ä»£å’Œå…ƒç©ºé—´éƒ½ä¸æ˜¯åœ¨å †ç©ºé—´ä¸­å®ç°çš„ã€‚



> ä¸€äº›ç­‰ä»·å«æ³•ï¼š
>
> - æ–°ç”ŸåŒº=æ–°ç”Ÿä»£=å¹´è½»ä»£(Young/New Generation Space)
> - å…»è€åŒº=è€å¹´åŒº=è€å¹´ä»£(Tenure/Old Generation Space)
> - æ°¸ä¹…åŒº=æ°¸ä¹…ä»£(Permanent Space)



## è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM

- `-Xms`ï¼šè®¾ç½®å †åŒºçš„èµ·å§‹å†…å­˜ã€‚ç­‰ä»·äº-XX:InitialHeapSize

  é»˜è®¤æƒ…å†µä¸‹ï¼šä¸ºç‰©ç†å†…å­˜/64

- `-Xmx`ï¼šè®¾ç½®å †åŒºçš„æœ€å¤§å†…å­˜ã€‚ç­‰ä»·äº-XX:MaxHeapSize

  é»˜è®¤æƒ…å†µä¸‹ï¼šä¸ºç‰©ç†å†…å­˜/4

  ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡"-Xmx"æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸

> #### ğŸ’¡æ³¨æ„
>
> **æ­¤å¤„çš„å †åŒºï¼ŒæŒ‡çš„æ˜¯æ–°ç”Ÿä»£+è€å¹´ä»£**ã€‚ä¸åŒ…å«æ°¸ä¹…ä»£æˆ–å…ƒç©ºé—´ã€‚



> é€šå¸¸æƒ…å†µï¼Œ**-Xmså’Œ-Xmxä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼**ï¼š
>
> ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨Javaåƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåï¼Œä¸éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †åŒºçš„å¤§å°ã€‚ä»è€Œæå‡æ€§èƒ½ã€‚



```java
// JVM Option: -Xms600M -Xmx600M
public class RuntimeTest {
    public static void main(String[] args) throws InterruptedException {
        long initialMemory = Runtime.getRuntime().totalMemory() / 1024 / 1024;
        long maxMemory = Runtime.getRuntime().maxMemory() / 1024 / 1024;

        System.out.println("-Xms:" + initialMemory + "M");
        System.out.println("-Xmx:" + maxMemory + "M");

        Thread.sleep(1000_1000);
    }
}
```

***å¦‚ä½•æŸ¥çœ‹è®¾ç½®çš„å‚æ•°***ï¼š

1. jps + stat -gc è¿›ç¨‹id

   ```sh
   C:\Users\G_xy>jps
   27604
   30472 Jps
   26636 Launcher
   26780 RuntimeTest
   
   C:\Users\G_xy>jstat -gc 26780
    S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT
    0.0    0.0    0.0    0.0   32768.0   4096.0   581632.0     0.0      0.0    0.0    0.0    0.0        0    0.000   0      0.000   0      0.000    0.000
   ```

2. JVM Option:`-XX:+PrintGCDetails`ï¼šæ—¥å¿—åœ¨è¿›ç¨‹ç»“æŸå‰æ‰“å°

   ```
   -Xms:575M
   -Xmx:575M
   Heap
    PSYoungGen      total 179200K, used 9216K [0x00000000f3800000, 0x0000000100000000, 0x0000000100000000)
     eden space 153600K, 6% used [0x00000000f3800000,0x00000000f41001a0,0x00000000fce00000)
     from space 25600K, 0% used [0x00000000fe700000,0x00000000fe700000,0x0000000100000000)
     to   space 25600K, 0% used [0x00000000fce00000,0x00000000fce00000,0x00000000fe700000)
    ParOldGen       total 409600K, used 0K [0x00000000da800000, 0x00000000f3800000, 0x00000000f3800000)
     object space 409600K, 0% used [0x00000000da800000,0x00000000da800000,0x00000000f3800000)
    Metaspace       used 3124K, capacity 4496K, committed 4864K, reserved 1056768K
     class space    used 330K, capacity 388K, committed 512K, reserved 1048576K
   ```

> æ³¨æ„ï¼Œæ–°ç”Ÿä»£0åŒºå’Œæ–°ç”Ÿä»£1åŒºåœ¨ä½¿ç”¨æ—¶æ˜¯äºŒé€‰ä¸€è¿›è¡Œå­˜æ”¾çš„ï¼ˆé‡‡ç”¨çš„æ˜¯å¤åˆ¶ç®—æ³•ï¼‰ã€‚
>
> ä¹Ÿå°±æ˜¯è¯´ï¼šæ–°ç”Ÿä»£èƒ½å­˜æ”¾å¯¹è±¡çš„åŒºåŸŸä¸ºï¼šä¼Šç”¸å›­åŒº+æ–°ç”Ÿä»£çš„ä¸€ä¸ªåŒº



## å¹´è½»ä»£ä¸è€å¹´ä»£

- å­˜å‚¨åœ¨JVMä¸­çš„Javaå¯¹è±¡å¯ä»¥è¢«åˆ†ä¸ºä¸¤ç±»ï¼š
  - ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ã€‚
  - å£°æ˜å‘¨æœŸæ¯”è¾ƒé•¿çš„å¯¹è±¡ã€‚
- Javaå †åŒºå¯è¿›ä¸€æ­¥åˆ’åˆ†ä¸ºï¼š
  - å¹´è½»ä»£ï¼š
    - ä¼Šç”¸å›­åŒº
    - å¹¸å­˜è€…0åŒº & å¹¸å­˜è€…1åŒºï¼ˆæˆ–ç§°FromåŒº & ToåŒºï¼‰
  - è€å¹´ä»£

![image-20220516220322758](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516220322758.png)





***JVMå‚æ•°è®¾ç½®***ï¼š

- é…ç½®æ–°ç”Ÿä»£å’Œè€å¹´ä»£åœ¨å †ç»“æ„ä¸­çš„å æ¯”ï¼š

  é»˜è®¤ï¼š`-XX:NewRatio=2`ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼ˆå³1/3ï¼‰ï¼Œè€å¹´ä»£å 2ï¼ˆå³2/3ï¼‰ã€‚

- é…ç½®æ–°ç”Ÿä»£çš„Edenå’Œ å¦å¤–ä¸¤ä¸ªSurvivoråŒºçš„æ¯”ä¾‹ï¼š

  é»˜è®¤æ˜¯8:1:1ã€‚å¯é€šè¿‡å‚æ•°`-XX:SurvivorRatio=8`è®¾ç½®ã€‚

  > - é»˜è®¤å­˜åœ¨è‡ªé€‚åº”å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé€šè¿‡`-XX:-UseAdaptiveSizePolicy`å…³é—­ã€‚ä½†å®é™…æµ‹è¯•æ²¡ç”¨ã€‚
  >
  > - è™½ç„¶è§„èŒƒä¸­ä¹ŸæŒ‡æ˜é»˜è®¤ä¸º8:1:1ï¼Œä½†å®æµ‹ä¸º6:2:2ã€‚åªèƒ½é€šè¿‡æ˜¾å¼é…ç½®-XX:SurvivorRatioã€‚

- è®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°ï¼š`-Xmn`

![image-20220516220529934](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516220529934.png)

> è¿™ä¸¤ä¸ªå‚æ•°ï¼Œä¸€èˆ¬ä¸ä¼šè¿›è¡Œä¿®æ”¹ã€‚



- å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡ï¼Œéƒ½æ˜¯åœ¨EdenåŒºè¿›è¡Œåˆ†é…çš„ã€‚

  ï¼ˆè‹¥è¯¥å¯¹è±¡å¾ˆå¤§ï¼Œåˆ™æœ‰å¯èƒ½æ˜¯ç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ä¸­çš„ï¼‰

- ç»å¤§éƒ¨åˆ†çš„Javaå¯¹è±¡çš„é”€æ¯ï¼Œéƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œã€‚

![image-20220516222040839](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220516222040839.png)



## å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹

[å°šç¡…è°·å®‹çº¢åº·JVMå…¨å¥—æ•™ç¨‹ï¼ˆè¯¦è§£javaè™šæ‹Ÿæœºï¼‰_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1PJ411n7xZ?p=72&spm_id_from=pageDriver)



1. newå‡ºæ¥çš„å¯¹è±¡ï¼Œå…ˆæ”¾åœ¨ä¼Šç”¸å›­åŒºã€‚

   > ä½†ä¼Šç”¸å›­åŒºå­˜åœ¨å¤§å°é™åˆ¶

2. å½“ä¼Šç”¸å›­åŒºçš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼š

   JVMçš„åƒåœ¾å›æ”¶å™¨ï¼Œå°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆ**`YGC/Minor GC`**ï¼‰ï¼š

   - å°†ä¸å†è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚
   - å°†æ–°çš„å¯¹è±¡æ”¾å…¥ä¼Šç”¸å›­åŒº
   - **å°†ä¼Šç”¸å›­åŒºçš„å‰©ä½™å¯¹è±¡ï¼Œç§»åŠ¨åˆ°å¹¸å­˜è€…0åŒº**ã€‚

   ç»è¿‡æ­¤é˜¶æ®µï¼Œä¼Šç”¸å›­åŒºæ˜¯ç©ºçš„ã€‚

   > YGC/Minor GCï¼š
   >
   > - **è§¦å‘äºï¼šä¼Šç”¸å›­åŒºæ»¡æ—¶**
   > - **ä½†å¯¹æ•´ä¸ªå¹´è½»ä»£è¿›è¡Œå›æ”¶**

3. å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼š

   - å¹¸å­˜è€…0åŒºä¸­ä»ç„¶å¹¸å­˜çš„ï¼Œç§»åŠ¨åˆ°å¹¸å­˜è€…1åŒº
   - ä¼Šç”¸å›­åŒºçš„å¹¸å­˜å¯¹è±¡ï¼Œä¹Ÿç§»åŠ¨åˆ°å¹¸å­˜è€…1åŒº

4. ...

   > - æ¯ä¸ªå¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œç¬¬ä¸€æ¬¡ï¼ˆä»ä¼Šç”¸å›­åŒºï¼‰è¿›å…¥å¹¸å­˜è€…åŒºæ—¶ï¼Œå¹´é¾„è®¡æ•°å™¨ä¸º1
   > - æ¯è¿›è¡Œä¸€æ¬¡YGCï¼Œä»å¹¸å­˜å¯¹è±¡çš„å¹´é¾„è®¡æ•°å™¨+1

   å¹´é¾„è®¡æ•°å™¨ä¸º15çš„å¯¹è±¡ï¼Œå°†è¢«**æ™‹å‡ï¼ˆPromotionï¼‰**åˆ°è€å¹´ä»£ã€‚

   > å¯é€šè¿‡å‚æ•°è®¾ç½®ï¼š`-XX:MaxTenuringThreshold=<N>`

5. **å½“è€å¹´ä»£å†…å­˜ä¸è¶³æ—¶ï¼Œå°†è§¦å‘ Major GC/FGCï¼Œå¯¹è€å¹´ä»£è¿›è¡Œå†…å­˜æ¸…ç†**

   > è‹¥æ‰§è¡ŒMajor GCåï¼Œä»æ— è¶³å¤Ÿç©ºé—´ä¿å­˜è¯¥å¯¹è±¡ï¼Œå°†äº§ç”ŸOOMå¼‚å¸¸ï¼šjava.lang.OutOfMemoryError: Java heap space



![image-20220701210051363](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220701210051363.png)



### ç‰¹æ®Šæƒ…å†µ

![image-20220701211113771](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220701211113771.png)



## Minor GCã€Major GCã€Full GC

- Minor GCï¼ˆYGCï¼‰ï¼š
  - è§¦å‘äºï¼šæ–°ç”Ÿä»£çš„ä¼Šç”¸å›­åŒºæ»¡
  - æ•ˆæœï¼šå¯¹æ•´ä¸ªæ–°ç”Ÿä»£è¿›è¡ŒGC
- Major GCï¼ˆOGCï¼‰ï¼š
  - è§¦å‘äºï¼šè€å¹´ä»£æ»¡
  - æ•ˆæœï¼šå¯¹æ•´ä¸ªè€å¹´ä»£è¿›è¡ŒGC

- Full GCï¼š
  - è§¦å‘æƒ…å†µï¼š
    1. è°ƒç”¨System.gc()ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFull GCï¼Œä½†é€šå¸¸ä¸æ‰§è¡Œ
    2. è€å¹´ä»£ç©ºé—´ä¸è¶³
    3. æ–¹æ³•åŒºç©ºé—´ä¸è¶³
    4. é€šè¿‡Minor GCåï¼Œè¿›å…¥è€å¹´ä»£çš„å¯¹è±¡å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜
    5. Edenã€FromåŒºå‘ToåŒºå¤åˆ¶æ—¶ï¼ŒToåŒºæ”¾ä¸ä¸‹ï¼Œè€å¹´ä»£ä¹Ÿæ”¾ä¸ä¸‹
  - æ•ˆæœï¼šå¯¹æ•´ä¸ªJavaå †ï¼ˆæ–°ç”Ÿä»£+è€å¹´ä»£ï¼‰å’Œæ–¹æ³•åŒºè¿›è¡ŒGC

- Mixed GCï¼š
  - å¯¹æ•´ä¸ªæ–°ç”Ÿä»£ï¼Œä»¥åŠéƒ¨åˆ†è€å¹´ä»£è¿›è¡ŒGC



>- é¢‘ç‡ä¸Šï¼šYGCçš„æ¬¡æ•°æœ€å¤š
>
>- STWçš„æ—¶é•¿ï¼šOGCå’ŒFGCåœæ­¢ç”¨æˆ·çº¿ç¨‹çš„æ—¶é—´ï¼Œåœ¨YGCçš„10å€ä»¥ä¸Šã€‚
>
>  **ä¼˜åŒ–ä¸»è¦æ˜¯é’ˆå¯¹é¿å…OGCå’ŒFGC** 



>åƒåœ¾å›æ”¶å™¨ï¼š
>
>- åªæœ‰CMS GCï¼Œåœ¨GCæ—¶ä¼šå•ç‹¬æ”¶é›†è€å¹´ä»£ï¼ˆOGCï¼‰
>
>  > å› æ­¤ï¼Œå¾ˆå¤šæ—¶å€™Major GCå’ŒFull GCä¼šæ··æ·†ä½¿ç”¨
>
>- åªæœ‰G1 GCï¼Œä¼šè¿›è¡ŒMixed GC



## å†…å­˜åˆ†é…ç­–ç•¥ï¼ˆå¯¹è±¡æå‡(Promotion)ç­–ç•¥ï¼‰

- ä¼˜å…ˆåˆ†é…åˆ°Eden

- å¤§å¯¹è±¡ï¼Œå¾ˆå¯èƒ½ä¼šè¢«ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£

- é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œåˆ†é…åˆ°è€å¹´ä»£

- åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­ï¼š

  **å¦‚æœSurvivoråŒºä¸­ï¼Œç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°æ€»å’Œï¼Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ç›´æ¥è¿›å…¥è€å¹´ä»£**ã€‚

- ç©ºé—´åˆ†é…æ‹…ä¿ï¼š

  `-XX:HandlePromotionFailure`



## ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB

- TLABï¼šThread Local Allocation Buffer



### ä¸ºä»€ä¹ˆè¦æœ‰TLAB

- å †åŒºï¼Œæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®
- åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä»å †åŒºä¸­åˆ’åˆ†çš„å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„
- ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œå½±å“åˆ†é…é€Ÿåº¦ã€‚



### ä»€ä¹ˆæ˜¯TLAB

- ä»å†…å­˜æ¨¡å‹ï¼Œè€Œéåƒåœ¾æ”¶é›†çš„è§’åº¦ï¼Œ**å¯¹EdenåŒºè¿›ä¸€æ­¥åˆ’åˆ†ï¼ŒJVMä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å†²åŒºåŸŸ**
- **å½“å¤šä¸ªçº¿ç¨‹*åˆ†é…å†…å­˜*æ—¶ï¼Œä½¿ç”¨TLABå¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜**ï¼ŒåŒæ—¶è¿˜èƒ½æå‡å†…å­˜åˆ†é…çš„ååé‡ã€‚è¿™ç§ç­–ç•¥ä¹Ÿç§°ä¸ºâ€œå¿«é€Ÿåˆ†é…ç­–ç•¥â€ã€‚

![image-20220701223233320](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220701223233320.png)



### TLABè¡¥å……

- TLABï¼Œæ˜¯JVMè¿›è¡Œå†…å­˜åˆ†é…çš„é¦–é€‰

- é€šè¿‡é€‰é¡¹`-XX:UseTLAB`ï¼Œå¯ä»¥è®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´

- é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABå†…å­˜ç©ºé—´éå¸¸å°ï¼Œä»…å æ•´ä¸ªEdenç©ºé—´çš„1%ã€‚

  é€šè¿‡é€‰é¡¹`-XX:TLABWasteTargetPercent`è®¾ç½®

- è‹¥å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVMä¼šé€šè¿‡åŠ é”ç¡®ä¿æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œåœ¨Edenç©ºé—´ä¸­åˆ†é…å†…å­˜

![image-20220701223519143](%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.assets/image-20220701223519143.png)

[å°šç¡…è°·å®‹çº¢åº·JVMå…¨å¥—æ•™ç¨‹ï¼ˆè¯¦è§£javaè™šæ‹Ÿæœºï¼‰_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1PJ411n7xZ?p=80&spm_id_from=pageDriver&vd_source=be746efb77e979ca275e4f65f2d8cda3)



## å°ç»“å †ç©ºé—´çš„å‚æ•°è®¾ç½®



## å †ä¸æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©

