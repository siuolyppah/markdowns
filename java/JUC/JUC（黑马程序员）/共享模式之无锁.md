# ç›¸å¯¹äºä½¿ç”¨ç®¡ç¨‹çš„ç‰¹ç‚¹

éƒ½æ˜¯ä¸ºäº†è§£å†³å¹¶å‘å¸¦æ¥çš„æ‰§è¡Œç»“æœä¸å¯é¢„æœŸçš„é—®é¢˜ã€‚ä½†ï¼š

- ä½¿ç”¨ç®¡ç¨‹ï¼ˆsynchronizedï¼‰ï¼šæ‚²è§‚é”
- ä½¿ç”¨æ— é”å¹¶å‘ï¼šä¹è§‚é”



# æœ¬ç« å†…å®¹

- CAS ä¸ volatile
- åŸå­æ•´æ•°ï¼šJDKæä¾›çš„åŸºäºæ— é”å¹¶å‘çš„å…¸å‹å®ç°
- åŸå­å¼•ç”¨
- åŸå­ç´¯åŠ å™¨
- Unsafeç±»



# CASçš„æ¡ˆä¾‹

- æ¥å£ï¼š

  ```java
  interface Account {
      // è·å–ä½™é¢
      Integer getBalance();
      // å–æ¬¾
      void withdraw(Integer amount);
  
      /**
       * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
       * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
       */
      static void demo(Account account) {
          List<Thread> ts = new ArrayList<>();
          long start = System.nanoTime();
          for (int i = 0; i < 1000; i++) {
              ts.add(new Thread(() -> {
                  account.withdraw(10);
              }));
          }
          ts.forEach(Thread::start);
          ts.forEach(t -> {
              try {
                  t.join();
              } catch (InterruptedException e) {
                  e.printStackTrace();
              }
          });
          long end = System.nanoTime();
          System.out.println(account.getBalance()
                  + " cost: " + (end-start)/1000_000 + " ms");
      }
  }
  ```

- æ— é”çš„å®ç°ç±»ï¼š

  ```java
  public class AccountCas implements Account {
      private AtomicInteger balance;
  
      public AccountCas(Integer balance) {
          this.balance = new AtomicInteger(balance);
      }
  
      @Override
      public Integer getBalance() {
          return this.balance.get();
      }
  
      @Override
      public void withdraw(Integer amount) {
          while (true) {
              int prev = balance.get();
              int next = prev - amount;
  
              // (expectedValue, newValue)
              if (balance.compareAndSet(prev, next)) {
                  break;
              }
          }
      }
  
      public static void main(String[] args) {
          Account account = new AccountCas(10000);
          Account.demo(account);
      }
  }
  ```

  

# CASä¸volatile

## æ¡ˆä¾‹åˆ†æ

å‰é¢çœ‹åˆ°çš„ AtomicInteger çš„è§£å†³æ–¹æ³•ï¼Œ**å†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨**ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

```java
public void withdraw(Integer amount) {
    while(true) {
        // éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
        while (true) {
            // æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000
            int prev = balance.get();
            // åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990
            int next = prev - amount;
            
            /*
             compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼
             - ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥
             æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990
             é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•
             - ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ
             */
            if (balance.compareAndSet(prev, next)) {
                break;
            }
        }
    }
}
```

å…¶ä¸­çš„å…³é”®æ˜¯ compareAndSetï¼Œå®ƒçš„ç®€ç§°å°±æ˜¯ CAS ï¼ˆä¹Ÿæœ‰ Compare And Swap çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯**åŸå­æ“ä½œ**ã€‚

> CASæ“ä½œï¼Œæ˜¯åœ¨CPUæŒ‡ä»¤é›†çº§åˆ«ä¸Šï¼ˆX86æ¶æ„çš„lock cmpxchgæŒ‡ä»¤ï¼‰æä¾›çš„æ”¯æŒã€‚
>
> ***èƒ½ä¿è¯æ¯”è¾ƒå¹¶äº¤æ¢æ“ä½œçš„åŸå­æ€§***ã€‚
>
> > åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå†å¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­çš„ã€‚



![image-20220514170128704](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%97%A0%E9%94%81.assets/image-20220514170128704.png)



## volatile

è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥**é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼**ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚

> #### ğŸ’¡æ³¨æ„
>
> volatile ä»…ä»…ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§ï¼Œè®©å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™é—®é¢˜ï¼ˆä¸èƒ½ä¿è¯åŸå­æ€§ï¼‰

CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœ



`AtomicInteger`ç±»ï¼š

```java
public class AtomicInteger extends Number implements java.io.Serializable {
	
    ...
    private volatile int value;
}
```



## ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜

- æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼›
- è€Œ synchronized ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚



## CASçš„ç‰¹ç‚¹

ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œ**é€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸ CPU çš„åœºæ™¯**ä¸‹ã€‚

- CAS æ˜¯åŸºäº**ä¹è§‚é”**çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å†é‡è¯•å‘—ã€‚
- synchronized æ˜¯åŸºäº**æ‚²è§‚é”**çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³ æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚
- CAS ä½“ç°çš„æ˜¯**æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘**ï¼Œè¯·ä»”ç»†ä½“ä¼šè¿™ä¸¤å¥è¯çš„æ„æ€
  - å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€
  - ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“



# åŸå­æ•´æ•°

J.U.C å¹¶å‘åŒ…æä¾›äº†ï¼š

- AtomicBoolean
- AtomicInteger
- AtomicLong



ä»¥ AtomicInteger ä¸ºä¾‹ï¼š

```java
AtomicInteger i = new AtomicInteger(0);

// è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++
System.out.println(i.getAndIncrement());

// è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i
System.out.println(i.incrementAndGet());

// è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i
System.out.println(i.decrementAndGet());

// è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--
System.out.println(i.getAndDecrement());

// è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰
System.out.println(i.getAndAdd(5));

// åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰
System.out.println(i.addAndGet(-5));

// è·å–å¹¶æ›´æ–°ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.getAndUpdate(p -> p - 2));

// æ›´æ–°å¹¶è·å–ï¼ˆi = -2, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.updateAndGet(p -> p + 2));

// è·å–å¹¶è®¡ç®—ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 10, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
// getAndUpdate å¦‚æœåœ¨ lambda ä¸­å¼•ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¦ä¿è¯è¯¥å±€éƒ¨å˜é‡æ˜¯ final çš„
// getAndAccumulate å¯ä»¥é€šè¿‡ å‚æ•°1 æ¥å¼•ç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä½†å› ä¸ºå…¶ä¸åœ¨ lambda ä¸­å› æ­¤ä¸å¿…æ˜¯ final
System.out.println(i.getAndAccumulate(10, (p, x) -> p + x));

// è®¡ç®—å¹¶è·å–ï¼ˆi = 10, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.accumulateAndGet(-10, (p, x) -> p + x));
```



# åŸå­å¼•ç”¨

[é»‘é©¬ç¨‹åºå‘˜å…¨é¢æ·±å…¥å­¦ä¹ Javaå¹¶å‘ç¼–ç¨‹ï¼ŒJUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV16J411h7Rd?p=169)
