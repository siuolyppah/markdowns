# æœ¬ç« å†…å®¹

- ä¸Šä¸€ç« è®²è§£çš„ Monitor ä¸»è¦å…³æ³¨çš„æ˜¯è®¿é—®å…±äº«å˜é‡æ—¶ï¼Œä¿è¯ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ€§
- è¿™ä¸€ç« æˆ‘ä»¬è¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ å…±äº«å˜é‡åœ¨å¤šçº¿ç¨‹é—´çš„ã€å¯è§æ€§ã€‘é—®é¢˜ä¸å¤šæ¡æŒ‡ä»¤æ‰§è¡Œæ—¶çš„ã€æœ‰åºæ€§ã€‘é—®é¢˜



# Javaå†…å­˜æ¨¡å‹

JMM å³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†**ä¸»å­˜**ã€**å·¥ä½œå†…å­˜**æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€ CPU å¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPU æŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚

- ä¸»å­˜ï¼šå­˜å‚¨æ‰€æœ‰çº¿ç¨‹çš„å…±äº«ä¿¡æ¯
- å·¥ä½œå†…å­˜ï¼šå­˜å‚¨çº¿ç¨‹ç§æœ‰çš„ä¿¡æ¯





JMM ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- åŸå­æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“
- å¯è§æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu <u>ç¼“å­˜</u>çš„å½±å“
- æœ‰åºæ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu æŒ‡ä»¤<u>å¹¶è¡Œä¼˜åŒ–</u>çš„å½±å“



# å¯è§æ€§

## é€€ä¸å‡ºçš„å¾ªç¯

```java
@Slf4j(topic = "c.Test32")
public class Test32 {

    static boolean run = true;

    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            while (run) {

            }
            log.debug("stopped");
        });

        t.start();
        Thread.sleep(1000);
        log.debug("should stop then");
        run = false;
    }
}
```

ä¸€ç§’ä¹‹åï¼Œtçº¿ç¨‹å¹¶ä¸ä¼šåƒé¢„æœŸé‚£æ ·è¢«åœæ­¢ã€‚



åŸå› åœ¨äºï¼š

1. åœ¨åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚

   ![image-20220502202051364](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502202051364.png)

2. å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼Œ***JIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­***ï¼Œ å‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡

   ![image-20220502202059488](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502202059488.png)

3. 1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡ çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼

   ![image-20220502202108952](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502202108952.png)



## è§£å†³æ–¹æ³•

`volatile`ï¼ˆæ˜“å˜å…³é”®å­—ï¼‰ï¼š

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°***æˆå‘˜å˜é‡***å’Œ***é™æ€æˆå‘˜å˜é‡***ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œ***çº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜***



> äº‹å®ä¸Šï¼Œsynchronizedå…³é”®å­—ä¹Ÿèƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼š
>
> ```java
> @Slf4j(topic = "c.Test32")
> public class Test32 {
> 
>     static boolean run = true;
> 
>     final static Object lock = new Object();
> 
>     public static void main(String[] args) throws InterruptedException {
>         Thread t = new Thread(() -> {
>             while (true) {
> 
>                 synchronized (lock) {
>                     if (!run) {
>                         break;
>                     }
>                 }
>             }
>             log.debug("stopped");
>         });
> 
>         t.start();
> 
>         Thread.sleep(1000);
>         log.debug("should stop then");
> 
>         synchronized (lock) {
>             run = false;
>         }
>     }
> }
> ```



## å¯è§æ€§ vs åŸå­æ€§

å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼š

- ***ä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§***ï¼ˆå› ä¸ºæ­¤æ—¶å¯¹å˜é‡çš„ä¿®æ”¹ï¼Œéƒ½æ˜¯å¯¹ä¸»å­˜çš„ä¿®æ”¹ï¼‰

- ä½†ä¸èƒ½ä¿è¯åŸå­æ€§ï¼ˆå› ä¸ºåªèƒ½ä¿è¯çœ‹åˆ°ã€Œæœ€æ–°å€¼ã€ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™çš„é—®é¢˜ï¼‰ã€‚ä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µ



[ä¸Šä¾‹](#é€€ä¸å‡ºçš„å¾ªç¯)ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„ï¼š

```java
getstatic run // çº¿ç¨‹ t è·å– run true 
getstatic run // çº¿ç¨‹ t è·å– run true 
getstatic run // çº¿ç¨‹ t è·å– run true 
getstatic run // çº¿ç¨‹ t è·å– run true 
putstatic run // çº¿ç¨‹ main ä¿®æ”¹ run ä¸º falseï¼Œ ä»…æ­¤ä¸€æ¬¡
getstatic run // çº¿ç¨‹ t è·å– run false 
```



>#### ğŸ’¡æ³¨æ„ï¼š
>
>- synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œ**ä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§**ã€‚
>- ä½†ç¼ºç‚¹æ˜¯ synchronized æ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½ åºæ€§



## è®¾è®¡æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µåœæ­¢

è§JUCè®¾è®¡æ¨¡å¼.md

```java
public class Test8 {
    public static void main(String[] args) throws InterruptedException {
        TwoPhaseTermination tpt = new TwoPhaseTermination();

        tpt.start();
        Thread.sleep(5_000);
        tpt.stop();
    }
}

@Slf4j(topic = "c.monitor")
class TwoPhaseTermination {
    private Thread monitor;
    private volatile boolean stop;

    public void start() {
        monitor = new Thread(() -> {
            while (true) {
                if (stop) {
                    log.debug("çº¿ç¨‹è¢«æ‰“æ–­ï¼Œå°†è¦é€€å‡º");
                    break;
                }

                try {
                    Thread.sleep(2_000);
                    log.debug("è®°å½•ç›‘æ§ä¿¡æ¯");
                } catch (InterruptedException e) {

                    stop = true;    // è€ƒè™‘è¢«æ‰“æ–­çš„æƒ…å†µ
                    e.printStackTrace();
                }
            }
        });

        monitor.start();
    }

    public void stop() {
        stop = true;
    }
}
```



# æœ‰åºæ€§

JVM ä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚



## æŒ‡ä»¤é‡æ’

æ€è€ƒä¸‹é¢ä¸€æ®µä»£ç ï¼š

```java
static int i;
static int j;
// åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ
i = ...; 
j = ...; 
```

å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œæ—¢å¯ä»¥æ˜¯ï¼š
```java
i = ...; 
j = ...;
```

ä¹Ÿå¯ä»¥æ˜¯ï¼š

```java
j = ...;
i = ...; 
```



***è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œä½†åœ¨å¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§***ã€‚



### æŒ‡ä»¤é‡æ’çš„åŸç†

æ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼š `å–æŒ‡ä»¤` - `æŒ‡ä»¤è¯‘ç ` - `æ‰§è¡ŒæŒ‡ä»¤` - `å†…å­˜è®¿é—®` - `æ•°æ®å†™å›` è¿™ 5 ä¸ªé˜¶æ®µ

![image-20220502215003895](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502215003895.png)

>æœ¯è¯­å‚è€ƒï¼š
>
>- instruction fetch (IF)
>- instruction decode (ID)
>- execute (EX)
>- memory access (MEM)
>- register write back (WB)

åœ¨ä¸æ”¹å˜ç¨‹åºç»“æœçš„å‰æä¸‹ï¼Œè¿™äº›æŒ‡ä»¤çš„å„ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡**é‡æ’åº**å’Œç»„åˆæ¥å®ç°**æŒ‡ä»¤çº§å¹¶è¡Œ**



### æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨

ç°ä»£ CPU æ”¯æŒå¤šçº§æŒ‡ä»¤æµæ°´çº¿ï¼Œä¾‹å¦‚æ”¯æŒåŒæ—¶æ‰§è¡Œ å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å› çš„å¤„ç† å™¨ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸º**äº”çº§æŒ‡ä»¤æµæ°´çº¿**ã€‚

è¿™æ—¶ CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µï¼ˆç›¸å½“äºä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å¤æ‚æŒ‡ä»¤ï¼‰ï¼ŒIPC = 1ï¼Œæœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å®ƒå˜ç›¸åœ°æé«˜äº† æŒ‡ä»¤åœ°ååç‡

![image-20220502215335426](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502215335426.png)



### SuperScalar å¤„ç†å™¨

å¤§å¤šæ•°å¤„ç†å™¨åŒ…å«å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è®¡ç®—åŠŸèƒ½éƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œå¯ä»¥å†ç»†åˆ†ä¸ºæ•´æ•°è¿ç®—å•å…ƒã€æµ®ç‚¹æ•°è¿ç®—å•å…ƒç­‰ï¼Œè¿™æ ·å¯ä»¥æŠŠå¤šæ¡æŒ‡ä»¤ä¹Ÿå¯ä»¥åšåˆ°å¹¶è¡Œè·å–ã€è¯‘ç ç­‰ï¼ŒCPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œæ‰§è¡Œå¤šäºä¸€æ¡æŒ‡ä»¤ï¼ŒIPC> 1

![image-20220502215417223](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502215417223.png)



## æŒ‡ä»¤é‡æ’å¯¼è‡´å‡ºé”™çš„ä¾‹å­

```java
int num = 0;
boolean ready = false;

// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor1(I_Result r) {
    if(ready) {
        r.r1 = num + num;
    } else {
        r.r1 = 1;
    }
}

// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor2(I_Result r) { 
    num = 2;
    ready = true; 
}
```

I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ

- çº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1

- çº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1

- çº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰

- **æŒ‡ä»¤é‡æ’çš„æƒ…å†µ**ï¼š

  çº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œ num = 2



### å¤ç°

[è§†é¢‘é“¾æ¥](https://www.bilibili.com/video/BV16J411h7Rd?p=144&spm_id_from=pageDriver)



è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼š

- å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress https://wiki.openjdk.java.net/display/CodeTools/jcstress

```sh
mvn archetype:generate -DinteractiveMode=false -DarchetypeGroupId=org.openjdk.jcstress -DarchetypeArtifactId=jcstress-java-test-archetype -DarchetypeVersion=0.5 -DgroupId=cn.itcast -DartifactId=ordering -Dversion=1.0 
```

1. åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»ï¼š

   ```java
   @JCStressTest
   @Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
   @Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
   @State
   public class ConcurrencyTest {
       int num = 0;
       boolean ready = false;
       @Actor
       public void actor1(I_Result r) {
           if(ready) {
               r.r1 = num + num;
           } else {
               r.r1 = 1;
           }
       }
       @Actor
       public void actor2(I_Result r) {
           num = 2;
           ready = true;
       }
   }
   ```

2. æ‰§è¡Œï¼š

   ```
   mvn clean install 
   java -jar target/jcstress.jar 
   ```

3. ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š

   ![image-20220502221028632](%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98.assets/image-20220502221028632.png)

   å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚

   

### è§£å†³æ–¹æ³•ï¼ˆvolatileï¼‰

***volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’***ã€‚



```java
@JCStressTest

@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
@State
public class ConcurrencyTest {
    int num = 0;
    volatile boolean ready = false;
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
            r.r1 = num + num;
        } else {
            r.r1 = 1;
        }
    }
    @Actor
    public void actor2(I_Result r) {
        num = 2;
        // åœ¨readyä¸Šæ·»åŠ volatileï¼Œå¯ä»¥ä¿è¯åœ¨æ­¤ä¹‹å‰çš„ä»£ç ä¸ä¼šè¢«é‡æ’
        ready = true;
    }
}
```

ç»“æœä¸ºï¼š

```
*** INTERESTING tests 
 Some interesting behaviors observed. This is for the plain curiosity. 
 
 0 matching test results. 
```



# volatileåŸç†

[é»‘é©¬ç¨‹åºå‘˜å…¨é¢æ·±å…¥å­¦ä¹ Javaå¹¶å‘ç¼–ç¨‹ï¼ŒJUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV16J411h7Rd?p=146&spm_id_from=pageDriver)
